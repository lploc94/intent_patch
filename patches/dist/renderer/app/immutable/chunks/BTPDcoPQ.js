const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["app/immutable/chunks/CA0vlnYV.js","app/immutable/chunks/lcKMvzO1.js","app/immutable/chunks/ZnJkZZV5.js","app/immutable/chunks/C6aID195.js"])))=>i.map(i=>d[i]);
var mt=Object.defineProperty;var Fe=a=>{throw TypeError(a)};var ft=(a,e,t)=>e in a?mt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var g=(a,e,t)=>ft(a,typeof e!="symbol"?e+"":e,t),pt=(a,e,t)=>e.has(a)||Fe("Cannot "+t);var _=(a,e,t)=>(pt(a,e,"read from private field"),t?t.call(a):e.get(a)),F=(a,e,t)=>e.has(a)?Fe("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(a):e.set(a,t);import{p as Ce,b as H,a as Ue,r as yt,c as We,A as Et}from"./B-7-Y0L_.js";import{_ as It}from"./ckwbz45p.js";import{c as M}from"./DvyKzjFb.js";import{L as xe}from"./lcKMvzO1.js";import{t as Ie}from"./BPmiYELv.js";import{u as h,a as Se}from"./CA0vlnYV.js";import{az as St,U as vt,V as Tt,bt as At,by as wt,bb as kt,p as Rt,o as _t,q as bt,v as Mt,g as U,k as W,b as Ge,i as Ct,w as ve,f as Ot,c as Nt,y as Dt,r as Lt,j as G,l as Be}from"./FWapvpP5.js";import{invoke as T}from"./LSn8Fut5.js";import{C as Te,d as j,A as q}from"./uOTxuk7I.js";import{a as Ae,S as xt,M as Pt,W as we,e as Ft,T as Ut,f as Wt,U as Gt,N as Bt,g as Vt,h as $t,j as zt,b as Ve}from"./ZnJkZZV5.js";import{v as Oe}from"./C6aID195.js";import{c as qt,p as ke,i as Yt,a as jt,u as Xt}from"./CKZOhV4i.js";function Ht(a,e,t){St(()=>{var s=vt(()=>e(a,t==null?void 0:t())||{});if(t&&(s!=null&&s.update)){var r=!1,i={};Tt(()=>{var n=t();At(n),r&&wt(i,n)&&(i=n,s.update(n))}),r=!0}if(s!=null&&s.destroy)return()=>s.destroy()})}const $e={AGENT_CREATION:"https://docs.example.com/agent-creation",STREAMING:"https://docs.example.com/streaming-issues",STORAGE:"https://docs.example.com/storage-troubleshooting",MEMORY:"https://docs.example.com/memory-management",PROVIDER:"https://docs.example.com/provider-setup",GENERAL:"https://docs.example.com/help"},Re={AGENT_CREATION_FAILED:"Failed to create agent '{agentName}'. {details}",AGENT_ALREADY_EXISTS:"An agent named '{agentName}' already exists in this space.",INVALID_AGENT_CONFIG:"Invalid agent configuration: {details}",INVALID_CONFIG:"Invalid configuration: {details}",SESSION_NOT_FOUND:"The chat session (ID: {sessionId}) could not be found. It may have expired.",SESSION_ALREADY_ACTIVE:"This agent session is already active. Cannot start another session.",SESSION_INITIALIZATION_FAILED:"Failed to initialize agent session: {details}",STREAM_CONNECTION_FAILED:"Failed to establish streaming connection to agent. {details}",STREAM_TIMEOUT:"Response timeout after {timeout}ms. The agent may be processing a complex request.",STREAM_INTERRUPTED:"Connection interrupted. Attempting to reconnect... (Attempt {attempt}/{maxAttempts})",STREAM_RECOVERY_FAILED:"Failed to recover streaming connection after {attempts} attempts.",MESSAGE_SEND_FAILED:"Failed to send message: {details}",MESSAGE_VALIDATION_FAILED:"Invalid message format: {details}",MESSAGE_TOO_LONG:"Message exceeds maximum length of {maxLength} characters. Current: {currentLength}",PROVIDER_NOT_FOUND:"Agent provider '{provider}' not found.",PROVIDER_CONNECTION_FAILED:"Failed to connect to provider '{provider}': {details}",PROVIDER_PROCESS_DIED:"Agent process for provider '{provider}' terminated unexpectedly.",STORAGE_READ_FAILED:"Failed to load agent data from storage: {details}",STORAGE_WRITE_FAILED:"Failed to save agent data to storage: {details}",STORAGE_CORRUPTED:"Agent data appears to be corrupted. Last backup: {lastBackup}",MEMORY_LIMIT_EXCEEDED:"Memory limit exceeded ({currentUsage}MB / {limit}MB). Please close some agents.",RATE_LIMIT_EXCEEDED:"Too many requests ({count} in {window}ms). Please slow down.",CONCURRENT_LIMIT_EXCEEDED:"Too many concurrent agents ({current}/{max}). Please close some agents."},Kt={AGENT_CREATION_FAILED:"We couldn't create your agent. Please check your settings and try again.",AGENT_ALREADY_EXISTS:"An agent with this name already exists. Please choose a different name.",INVALID_AGENT_CONFIG:"Your agent configuration is invalid. Please review and correct it.",INVALID_CONFIG:"The configuration provided is invalid. Please check and try again.",SESSION_NOT_FOUND:"The chat session has expired. Please start a new conversation.",SESSION_ALREADY_ACTIVE:"This agent session is already running. Please wait or close it first.",SESSION_INITIALIZATION_FAILED:"We couldn't start the agent session. Please try again.",STREAM_CONNECTION_FAILED:"We couldn't connect to the agent. Please check your connection and try again.",STREAM_TIMEOUT:"The agent took too long to respond. Please try again or check if it's still running.",STREAM_INTERRUPTED:"Your connection was interrupted. We're trying to reconnect...",STREAM_RECOVERY_FAILED:"We couldn't reconnect to the agent. Please try again.",MESSAGE_SEND_FAILED:"We couldn't send your message. Please try again.",MESSAGE_VALIDATION_FAILED:"Your message format is invalid. Please check and try again.",MESSAGE_TOO_LONG:"Your message is too long. Please shorten it and try again.",PROVIDER_NOT_FOUND:"The agent provider is not available. Please check your setup.",PROVIDER_CONNECTION_FAILED:"We couldn't connect to the agent provider. Please check your configuration.",PROVIDER_PROCESS_DIED:"The agent process stopped unexpectedly. Please restart it.",STORAGE_READ_FAILED:"We couldn't load your agent data. Please try again.",STORAGE_WRITE_FAILED:"We couldn't save your agent data. Please try again.",STORAGE_CORRUPTED:"Your agent data appears to be corrupted. Please restore from backup.",MEMORY_LIMIT_EXCEEDED:"You're using too much memory. Please close some agents.",RATE_LIMIT_EXCEEDED:"You're making too many requests. Please slow down.",CONCURRENT_LIMIT_EXCEEDED:"You have too many agents running. Please close some."};function Jt(a){return(a.match(/{(\w+)}/g)||[]).map(t=>t.slice(1,-1))}function Zt(a,e){return Jt(a).every(s=>s in e)}function st(a,e={}){return a.replace(/{(\w+)}/g,(t,s)=>String(e[s]??t))}function _e(a){const e="Something went wrong. Please try again.";if(!a)return e;let t=a;return t=t.replace(/^.*?failed(?:\s+to\s+.*?)?\s+after\s+\d+\s+attempts:\s*/i,""),t=t.replace(/^Error invoking remote method '[^']+':(\s*Error:)?\s*/i,""),t=t.replace(/^(Error:\s*)+/i,""),t=t.replace(/\n\s*at .+/g,""),t=t.replace(/\s+/g," ").trim(),t||e}function Qt(a,e){return e&&Re[a]&&Zt(Re[a],e)?st(Re[a],e):Kt[a]||"An unexpected error occurred."}function es(a){const t={AGENT_CREATION_FAILED:"AGENT_CREATION",AGENT_ALREADY_EXISTS:"AGENT_CREATION",INVALID_AGENT_CONFIG:"AGENT_CREATION",STREAM_CONNECTION_FAILED:"STREAMING",STREAM_TIMEOUT:"STREAMING",STREAM_INTERRUPTED:"STREAMING",STREAM_RECOVERY_FAILED:"STREAMING",STORAGE_READ_FAILED:"STORAGE",STORAGE_WRITE_FAILED:"STORAGE",STORAGE_CORRUPTED:"STORAGE",MEMORY_LIMIT_EXCEEDED:"MEMORY",RATE_LIMIT_EXCEEDED:"MEMORY",CONCURRENT_LIMIT_EXCEEDED:"MEMORY",PROVIDER_NOT_FOUND:"PROVIDER",PROVIDER_CONNECTION_FAILED:"PROVIDER",PROVIDER_PROCESS_DIED:"PROVIDER"}[a];return t?$e[t]:$e.GENERAL}const ts={AGENT_CREATION_FAILED:[{action:"retry",description:"Try creating the agent again",automatic:!1,priority:"high"},{action:"check-config",description:"Verify agent configuration in settings",automatic:!1,priority:"high"},{action:"check-resources",description:"Ensure sufficient memory and disk space",automatic:!1,priority:"medium"}],AGENT_ALREADY_EXISTS:[{action:"rename",description:"Choose a different name for the agent",automatic:!1,priority:"high"},{action:"delete-existing",description:"Delete the existing agent first",automatic:!1,priority:"medium"}],INVALID_AGENT_CONFIG:[{action:"review-config",description:"Review and correct the configuration",automatic:!1,priority:"high"},{action:"use-defaults",description:"Reset to default configuration",automatic:!1,priority:"medium"}],INVALID_CONFIG:[{action:"review-config",description:"Review and correct the configuration",automatic:!1,priority:"high"},{action:"use-defaults",description:"Reset to default configuration",automatic:!1,priority:"medium"}],SESSION_NOT_FOUND:[{action:"start-new",description:"Start a new agent session",automatic:!1,priority:"high"},{action:"check-history",description:"Check session history for recent sessions",automatic:!1,priority:"medium"}],SESSION_ALREADY_ACTIVE:[{action:"wait",description:"Wait for the current session to complete",automatic:!1,priority:"high"},{action:"cancel",description:"Cancel the active session first",automatic:!1,priority:"high"}],SESSION_INITIALIZATION_FAILED:[{action:"retry",description:"Try initializing the session again",automatic:!1,priority:"high"},{action:"check-resources",description:"Ensure sufficient resources are available",automatic:!1,priority:"medium"}],MESSAGE_SEND_FAILED:[{action:"retry",description:"Try sending the message again",automatic:!1,priority:"high"},{action:"check-connection",description:"Check your network connection",automatic:!1,priority:"high"}],MESSAGE_VALIDATION_FAILED:[{action:"review-config",description:"Review and correct the message format",automatic:!1,priority:"high"},{action:"check-config",description:"Check configuration for valid message format",automatic:!1,priority:"medium"}],MESSAGE_TOO_LONG:[{action:"retry",description:"Shorten the message and try again",automatic:!1,priority:"high"},{action:"batch",description:"Split the message into multiple parts",automatic:!1,priority:"medium"}],PROVIDER_NOT_FOUND:[{action:"check-config",description:"Verify provider is properly configured",automatic:!1,priority:"high"},{action:"recreate",description:"Install or reinstall the provider",automatic:!1,priority:"high"}],PROVIDER_CONNECTION_FAILED:[{action:"retry",description:"Try connecting to the provider again",automatic:!1,priority:"high"},{action:"check-config",description:"Verify provider configuration",automatic:!1,priority:"high"}],STORAGE_READ_FAILED:[{action:"retry",description:"Try reading the data again",automatic:!1,priority:"high"},{action:"restore",description:"Restore from a recent backup",automatic:!1,priority:"medium"}],STORAGE_WRITE_FAILED:[{action:"retry",description:"Try saving again",automatic:!1,priority:"high"},{action:"check-resources",description:"Check available disk space",automatic:!1,priority:"high"}],STREAM_CONNECTION_FAILED:[{action:"retry",description:"Try connecting again",automatic:!1,priority:"high"},{action:"check-connection",description:"Check your network connection",automatic:!1,priority:"high"}],STREAM_RECOVERY_FAILED:[{action:"restart",description:"Restart the agent",automatic:!1,priority:"high"},{action:"check-config",description:"Check error logs for more details",automatic:!1,priority:"medium"}],STREAM_INTERRUPTED:[{action:"reconnect",description:"Attempting automatic reconnection",automatic:!0,priority:"high"},{action:"retry",description:"Retry sending the message",automatic:!1,priority:"high"},{action:"check-connection",description:"Check your internet connection",automatic:!1,priority:"medium"}],STREAM_TIMEOUT:[{action:"wait",description:"Wait for agent to complete processing",automatic:!1,priority:"high"},{action:"cancel",description:"Cancel current operation",automatic:!1,priority:"medium"},{action:"increase-timeout",description:"Increase timeout in settings",automatic:!1,priority:"low"}],PROVIDER_PROCESS_DIED:[{action:"restart",description:"Restart agent process",automatic:!0,priority:"high"},{action:"recreate",description:"Create new agent session",automatic:!1,priority:"high"}],STORAGE_CORRUPTED:[{action:"restore",description:"Restore from backup",automatic:!1,priority:"high"},{action:"reset",description:"Reset agent data",automatic:!1,priority:"medium"}],MEMORY_LIMIT_EXCEEDED:[{action:"cleanup",description:"Close unused agents",automatic:!1,priority:"high"},{action:"increase-limit",description:"Increase memory limit in settings",automatic:!1,priority:"medium"}],RATE_LIMIT_EXCEEDED:[{action:"wait",description:"Wait before making more requests",automatic:!1,priority:"high"},{action:"batch",description:"Batch requests together",automatic:!1,priority:"medium"}],CONCURRENT_LIMIT_EXCEEDED:[{action:"close-agents",description:"Close some running agents",automatic:!1,priority:"high"},{action:"queue",description:"Queue operation for later",automatic:!1,priority:"medium"}]};function ss(a){return ts[a]||[{action:"retry",description:"Try the operation again",automatic:!1,priority:"high"}]}new xe("AgentErrors");var D=(a=>(a.AGENT_CREATION_FAILED="AGENT_CREATION_FAILED",a.AGENT_ALREADY_EXISTS="AGENT_ALREADY_EXISTS",a.INVALID_AGENT_CONFIG="INVALID_AGENT_CONFIG",a.INVALID_CONFIG="INVALID_CONFIG",a.SESSION_NOT_FOUND="SESSION_NOT_FOUND",a.SESSION_ALREADY_ACTIVE="SESSION_ALREADY_ACTIVE",a.SESSION_INITIALIZATION_FAILED="SESSION_INITIALIZATION_FAILED",a.STREAM_CONNECTION_FAILED="STREAM_CONNECTION_FAILED",a.STREAM_TIMEOUT="STREAM_TIMEOUT",a.STREAM_INTERRUPTED="STREAM_INTERRUPTED",a.STREAM_RECOVERY_FAILED="STREAM_RECOVERY_FAILED",a.MESSAGE_SEND_FAILED="MESSAGE_SEND_FAILED",a.MESSAGE_VALIDATION_FAILED="MESSAGE_VALIDATION_FAILED",a.MESSAGE_TOO_LONG="MESSAGE_TOO_LONG",a.PROVIDER_NOT_FOUND="PROVIDER_NOT_FOUND",a.PROVIDER_CONNECTION_FAILED="PROVIDER_CONNECTION_FAILED",a.PROVIDER_PROCESS_DIED="PROVIDER_PROCESS_DIED",a.PROVIDER_UNAVAILABLE="PROVIDER_UNAVAILABLE",a.PROVIDER_ERROR="PROVIDER_ERROR",a.STORAGE_READ_FAILED="STORAGE_READ_FAILED",a.STORAGE_WRITE_FAILED="STORAGE_WRITE_FAILED",a.STORAGE_CORRUPTED="STORAGE_CORRUPTED",a.STORAGE_ERROR="STORAGE_ERROR",a.STORAGE_QUOTA_EXCEEDED="STORAGE_QUOTA_EXCEEDED",a.MEMORY_LIMIT_EXCEEDED="MEMORY_LIMIT_EXCEEDED",a.RATE_LIMIT_EXCEEDED="RATE_LIMIT_EXCEEDED",a.CONCURRENT_LIMIT_EXCEEDED="CONCURRENT_LIMIT_EXCEEDED",a.RESOURCE_NOT_FOUND="RESOURCE_NOT_FOUND",a.RESOURCE_EXHAUSTED="RESOURCE_EXHAUSTED",a.NETWORK_ERROR="NETWORK_ERROR",a.PERMISSION_DENIED="PERMISSION_DENIED",a.OPERATION_FAILED="OPERATION_FAILED",a.VALIDATION_ERROR="VALIDATION_ERROR",a.INVALID_RESPONSE="INVALID_RESPONSE",a.STATE_CORRUPTION="STATE_CORRUPTION",a.CONTEXT_OVERFLOW="CONTEXT_OVERFLOW",a))(D||{});class ue extends Error{constructor(t,s,r={},i){super(t);g(this,"code");g(this,"context");g(this,"recoverySuggestions");g(this,"userMessage");g(this,"isRecoverable");g(this,"cause");this.name="AgentError",this.code=s,this.context={...r,timestamp:new Date,stackTrace:this.stack},this.userMessage=(i==null?void 0:i.userMessage)||this.getDefaultUserMessage(s),this.recoverySuggestions=(i==null?void 0:i.recoverySuggestions)||this.getDefaultRecoverySuggestions(s),this.isRecoverable=(i==null?void 0:i.isRecoverable)??this.isErrorRecoverable(s),i!=null&&i.cause&&(this.cause=i.cause)}getDefaultUserMessage(t){return Qt(t,this.context)}getDefaultRecoverySuggestions(t){return ss(t)}isErrorRecoverable(t){return["STREAM_INTERRUPTED","STREAM_TIMEOUT","MESSAGE_SEND_FAILED","PROVIDER_PROCESS_DIED","STORAGE_READ_FAILED","STORAGE_WRITE_FAILED"].includes(t)}getHelpLink(){return es(this.code)}formatMessage(t){return st(t,this.context)}toJSON(){return{name:this.name,code:this.code,message:this.message,userMessage:this.userMessage,context:this.context,recoverySuggestions:this.recoverySuggestions,isRecoverable:this.isRecoverable,helpLink:this.getHelpLink(),stack:this.stack}}}const Js={AUTO_UPDATE_URL:"https://cdn.augmentcode.com"},ze={DEFAULT_ATTEMPTS:2,BASE_DELAY:1e3},qe={BACKEND_STREAM_TIMEOUT_MS:1800*1e3,FRONTEND_STREAM_CLEANUP_GRACE_MS:15e3,COMPLETION_DETECTION_MS:3600*1e3},rs={NON_RETRYABLE_ERRORS:["EACCES","EPERM","ENOSPC","EMFILE","permission","memory","fatal","process died","not available on your current plan","agent binary"]};function as(a){const e=a.toLowerCase();for(const t of rs.NON_RETRYABLE_ERRORS)if(e.includes(t.toLowerCase()))return!0;return!1}const N=M("ErrorBoundary"),V=class V{constructor(){}static getInstance(){return V.instance||(V.instance=new V),V.instance}async wrap(e,t,s={}){var le;const{retries:r=ze.DEFAULT_ATTEMPTS,retryDelay:i=ze.BASE_DELAY,exponentialBackoff:n=!0,fallback:o,notify:u=!1,notifyOnRetry:c=!1,context:l={},onError:E,onRetry:m,shouldRetry:w=this.defaultShouldRetry}=s;let p=null,v=0;for(v=1;v<=r+1;v++)try{N.debug(`[${t}] Attempt ${v}/${r+1}`);const Y=await e();return v>1&&N.info(`[${t}] Succeeded after ${v} attempts`),Y}catch(Y){if(p=Y,N.error(`[${t}] Attempt ${v} failed`,{error:p.message,attempt:v,maxAttempts:r+1,context:l}),E==null||E(p,v),v<=r&&w(p)){const C=n?i*Math.pow(2,v-1):i;c&&Ie.warning(`Something went wrong, retrying in ${C/1e3}s...`),m==null||m(v),N.info(`[${t}] Retrying in ${C}ms`),await this.sleep(C)}else break}const P=`${t} failed after ${v} attempt${v===1?"":"s"}: ${p==null?void 0:p.message}`,d=_e((p==null?void 0:p.message)||"Something went wrong. Please try again."),X=((le=p==null?void 0:p.message)==null?void 0:le.toLowerCase())||"",Ee=X.includes("no available models")||X.includes("all models exhausted")||X.includes("all models unavailable");if(u&&!Ee&&Ie.error(d),o!==void 0)return N.warn(`[${t}] Using fallback value`,{fallback:o}),o;throw new ue(d,D.OPERATION_FAILED,{originalError:p==null?void 0:p.message,detailedMessage:P,attempts:v,context:l})}async wrapVoid(e,t,s={}){await this.wrap(e,t,s)}wrapSync(e,t,s={}){try{return e()}catch(r){const i=r;if(N.error(`[${t}] Failed`,{error:i.message,context:s.context}),s.notify&&Ie.error(_e(i.message)),s.fallback!==void 0)return N.warn(`[${t}] Using fallback value`,{fallback:s.fallback}),s.fallback;throw new ue(_e(i.message),D.OPERATION_FAILED,s.context)}}defaultShouldRetry(e){const t=e.message.toLowerCase();return as(e.message)?!1:t.includes("network")||t.includes("timeout")?!0:e instanceof ue?[D.NETWORK_ERROR,D.STREAM_TIMEOUT,D.STREAM_CONNECTION_FAILED,D.PROVIDER_CONNECTION_FAILED,D.PROVIDER_UNAVAILABLE].includes(e.code):!(t.includes("invalid")||t.includes("interrupted")||t.includes("cancel")||t.includes("not found")||t.includes("not available")||t.includes("404")||t.includes("no available models")||t.includes("all models exhausted")||t.includes("all models unavailable")||t.includes("413")||t.includes("too long for the agent")||t.includes("request entity too large")||t.includes("payload too large")||t.includes("content too large")||t.includes("body too large")||t.includes("unauthorized")||t.includes("forbidden")||t.includes("401")||t.includes("403"))}sleep(e){return new Promise(t=>setTimeout(t,e))}async withTimeout(e,t,s){return Promise.race([e(),new Promise((r,i)=>setTimeout(()=>i(new ue(`${s} timed out after ${t}ms`,D.STREAM_TIMEOUT)),t))])}async batchOperations(e,t,s={}){const{concurrency:r=5,continueOnError:i=!0,operationName:n="batch operation"}=s,o=[],u=[];for(let c=0;c<e.length;c+=r){const l=e.slice(c,c+r);(await Promise.allSettled(l.map(m=>t(m)))).forEach((m,w)=>{if(m.status==="fulfilled")o.push(m.value);else{const p=m.reason;if(u.push({item:l[w],error:p}),N.error(`[${n}] Batch item failed`,{item:l[w],error:p.message}),!i)throw p}})}return u.length>0&&N.warn(`[${n}] Completed with ${u.length} errors`),{results:o,errors:u}}};g(V,"instance");let fe=V;const is=fe.getInstance();var ns=(a=>(a.PENDING="pending",a.ACTIVATING="activating",a.ACTIVE="active",a.ERROR="error",a))(ns||{});function Zs(a){return a.isPending===!0||a.status==="pending"}function Qs(a){var t,s;const e=a.provider??((t=a.metadata)==null?void 0:t.provider)??((s=a.config)==null?void 0:s.provider);if(e&&e!=="acp")return e;if(a.model)return Ce(a.model).providerId}const L=M("ConfigCacheProxy");class rt{async getModelConfig(e){try{const t=await T("config:get-model",{modelId:e});return t.success?t.data||null:(L.warn(`Model config not found for ${e}`),null)}catch(t){return L.error(`Failed to get model config for ${e}:`,t),null}}async getAllModels(){try{const e=await T("config:get-all-models",{});if(!e.success)throw new Error(e.error||"Failed to get models");return e.data||[]}catch(e){return L.error("Failed to get all models:",e),[]}}async clearCache(){try{await T(Te.CLEAR_CACHE,{}),L.info("Cache cleared")}catch(e){L.error("Failed to clear cache:",e)}}async invalidate(e){try{await T(Te.INVALIDATE,{key:e}),L.debug(`Invalidated cache key: ${e}`)}catch(t){L.error(`Failed to invalidate cache key ${e}:`,t)}}async getStats(){try{return(await T(Te.GET_STATS,{})).data||{}}catch(e){return L.error("Failed to get config cache stats:",e),{}}}}const os=new rt,cs=M("BrowserEventEmitter");class ls{constructor(){g(this,"events",new Map);g(this,"addListener",this.on);g(this,"removeListener",this.off)}on(e,t){return this.events.has(e)||this.events.set(e,new Set),this.events.get(e).add(t),this}once(e,t){const s=(...r)=>{this.off(e,s),t(...r)};return this.on(e,s)}off(e,t){const s=this.events.get(e);return s&&(s.delete(t),s.size===0&&this.events.delete(e)),this}emit(e,...t){const s=this.events.get(e);return!s||s.size===0?!1:(s.forEach(r=>{try{r(...t)}catch(i){cs.error(`Error in event listener for ${String(e)}:`,i)}}),!0)}removeAllListeners(e){return e?this.events.delete(e):this.events.clear(),this}listenerCount(e){const t=this.events.get(e);return t?t.size:0}eventNames(){return Array.from(this.events.keys())}}const Ye=a=>{a=1831565813+(a|=0)|0;let e=Math.imul(a^a>>>15,1|a);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296};class ds{constructor(e){this.dictionaries=void 0,this.length=void 0,this.separator=void 0,this.style=void 0,this.seed=void 0;const{length:t,separator:s,dictionaries:r,style:i,seed:n}=e;this.dictionaries=r,this.separator=s,this.length=t,this.style=i,this.seed=n}generate(){if(!this.dictionaries)throw new Error('Cannot find any dictionary. Please provide at least one, or leave the "dictionary" field empty in the config object');if(this.length<=0)throw new Error("Invalid length provided");if(this.length>this.dictionaries.length)throw new Error(`The length cannot be bigger than the number of dictionaries.
Length provided: ${this.length}. Number of dictionaries provided: ${this.dictionaries.length}`);let e=this.seed;return this.dictionaries.slice(0,this.length).reduce((t,s)=>{let r;e?(r=(n=>{if(typeof n=="string"){const o=n.split("").map(c=>c.charCodeAt(0)).reduce((c,l)=>c+l,1),u=Math.floor(Number(o));return Ye(u)}return Ye(n)})(e),e=4294967296*r):r=Math.random();let i=s[Math.floor(r*s.length)]||"";if(this.style==="lowerCase")i=i.toLowerCase();else if(this.style==="capital"){const[n,...o]=i.split("");i=n.toUpperCase()+o.join("")}else this.style==="upperCase"&&(i=i.toUpperCase());return t?`${t}${this.separator}${i}`:`${i}`},"")}}const je={separator:"_",dictionaries:[]},us=a=>{const e=[...a&&a.dictionaries||je.dictionaries],t={...je,...a,length:a&&a.length||e.length,dictionaries:e};if(!a||!a.dictionaries||!a.dictionaries.length)throw new Error('A "dictionaries" array must be provided. This is a breaking change introduced starting from Unique Name Generator v4. Read more about the breaking change here: https://github.com/andreasonny83/unique-names-generator#migration-guide');return new ds(t).generate()};var at=["able","above","absent","absolute","abstract","abundant","academic","acceptable","accepted","accessible","accurate","accused","active","actual","acute","added","additional","adequate","adjacent","administrative","adorable","advanced","adverse","advisory","aesthetic","afraid","aggregate","aggressive","agreeable","agreed","agricultural","alert","alive","alleged","allied","alone","alright","alternative","amateur","amazing","ambitious","amused","ancient","angry","annoyed","annual","anonymous","anxious","appalling","apparent","applicable","appropriate","arbitrary","architectural","armed","arrogant","artificial","artistic","ashamed","asleep","assistant","associated","atomic","attractive","automatic","autonomous","available","average","awake","aware","awful","awkward","back","bad","balanced","bare","basic","beautiful","beneficial","better","bewildered","big","binding","biological","bitter","bizarre","blank","blind","blonde","bloody","blushing","boiling","bold","bored","boring","bottom","brainy","brave","breakable","breezy","brief","bright","brilliant","broad","broken","bumpy","burning","busy","calm","capable","capitalist","careful","casual","causal","cautious","central","certain","changing","characteristic","charming","cheap","cheerful","chemical","chief","chilly","chosen","christian","chronic","chubby","circular","civic","civil","civilian","classic","classical","clean","clear","clever","clinical","close","closed","cloudy","clumsy","coastal","cognitive","coherent","cold","collective","colonial","colorful","colossal","coloured","colourful","combative","combined","comfortable","coming","commercial","common","communist","compact","comparable","comparative","compatible","competent","competitive","complete","complex","complicated","comprehensive","compulsory","conceptual","concerned","concrete","condemned","confident","confidential","confused","conscious","conservation","conservative","considerable","consistent","constant","constitutional","contemporary","content","continental","continued","continuing","continuous","controlled","controversial","convenient","conventional","convinced","convincing","cooing","cool","cooperative","corporate","correct","corresponding","costly","courageous","crazy","creative","creepy","criminal","critical","crooked","crowded","crucial","crude","cruel","cuddly","cultural","curious","curly","current","curved","cute","daily","damaged","damp","dangerous","dark","dead","deaf","deafening","dear","decent","decisive","deep","defeated","defensive","defiant","definite","deliberate","delicate","delicious","delighted","delightful","democratic","dependent","depressed","desirable","desperate","detailed","determined","developed","developing","devoted","different","difficult","digital","diplomatic","direct","dirty","disabled","disappointed","disastrous","disciplinary","disgusted","distant","distinct","distinctive","distinguished","disturbed","disturbing","diverse","divine","dizzy","domestic","dominant","double","doubtful","drab","dramatic","dreadful","driving","drunk","dry","dual","due","dull","dusty","dutch","dying","dynamic","eager","early","eastern","easy","economic","educational","eerie","effective","efficient","elaborate","elated","elderly","eldest","electoral","electric","electrical","electronic","elegant","eligible","embarrassed","embarrassing","emotional","empirical","empty","enchanting","encouraging","endless","energetic","enormous","enthusiastic","entire","entitled","envious","environmental","equal","equivalent","essential","established","estimated","ethical","ethnic","eventual","everyday","evident","evil","evolutionary","exact","excellent","exceptional","excess","excessive","excited","exciting","exclusive","existing","exotic","expected","expensive","experienced","experimental","explicit","extended","extensive","external","extra","extraordinary","extreme","exuberant","faint","fair","faithful","familiar","famous","fancy","fantastic","far","fascinating","fashionable","fast","fat","fatal","favourable","favourite","federal","fellow","female","feminist","few","fierce","filthy","final","financial","fine","firm","fiscal","fit","fixed","flaky","flat","flexible","fluffy","fluttering","flying","following","fond","foolish","foreign","formal","formidable","forthcoming","fortunate","forward","fragile","frail","frantic","free","frequent","fresh","friendly","frightened","front","frozen","full","fun","functional","fundamental","funny","furious","future","fuzzy","gastric","gay","general","generous","genetic","gentle","genuine","geographical","giant","gigantic","given","glad","glamorous","gleaming","global","glorious","golden","good","gorgeous","gothic","governing","graceful","gradual","grand","grateful","greasy","great","grieving","grim","gross","grotesque","growing","grubby","grumpy","guilty","handicapped","handsome","happy","hard","harsh","head","healthy","heavy","helpful","helpless","hidden","high","hilarious","hissing","historic","historical","hollow","holy","homeless","homely","hon","honest","horizontal","horrible","hostile","hot","huge","human","hungry","hurt","hushed","husky","icy","ideal","identical","ideological","ill","illegal","imaginative","immediate","immense","imperial","implicit","important","impossible","impressed","impressive","improved","inadequate","inappropriate","inc","inclined","increased","increasing","incredible","independent","indirect","individual","industrial","inevitable","influential","informal","inherent","initial","injured","inland","inner","innocent","innovative","inquisitive","instant","institutional","insufficient","intact","integral","integrated","intellectual","intelligent","intense","intensive","interested","interesting","interim","interior","intermediate","internal","international","intimate","invisible","involved","irrelevant","isolated","itchy","jealous","jittery","joint","jolly","joyous","judicial","juicy","junior","just","keen","key","kind","known","labour","large","late","latin","lazy","leading","left","legal","legislative","legitimate","lengthy","lesser","level","lexical","liable","liberal","light","like","likely","limited","linear","linguistic","liquid","literary","little","live","lively","living","local","logical","lonely","long","loose","lost","loud","lovely","low","loyal","ltd","lucky","mad","magic","magnetic","magnificent","main","major","male","mammoth","managerial","managing","manual","many","marginal","marine","marked","married","marvellous","marxist","mass","massive","mathematical","mature","maximum","mean","meaningful","mechanical","medical","medieval","melodic","melted","mental","mere","metropolitan","mid","middle","mighty","mild","military","miniature","minimal","minimum","ministerial","minor","miserable","misleading","missing","misty","mixed","moaning","mobile","moderate","modern","modest","molecular","monetary","monthly","moral","motionless","muddy","multiple","mushy","musical","mute","mutual","mysterious","naked","narrow","nasty","national","native","natural","naughty","naval","near","nearby","neat","necessary","negative","neighbouring","nervous","net","neutral","new","nice","noble","noisy","normal","northern","nosy","notable","novel","nuclear","numerous","nursing","nutritious","nutty","obedient","objective","obliged","obnoxious","obvious","occasional","occupational","odd","official","ok","okay","old","olympic","only","open","operational","opposite","optimistic","oral","ordinary","organic","organisational","original","orthodox","other","outdoor","outer","outrageous","outside","outstanding","overall","overseas","overwhelming","painful","pale","panicky","parallel","parental","parliamentary","partial","particular","passing","passive","past","patient","payable","peaceful","peculiar","perfect","permanent","persistent","personal","petite","philosophical","physical","plain","planned","plastic","pleasant","pleased","poised","polite","political","poor","popular","positive","possible","potential","powerful","practical","precious","precise","preferred","pregnant","preliminary","premier","prepared","present","presidential","pretty","previous","prickly","primary","prime","primitive","principal","printed","prior","private","probable","productive","professional","profitable","profound","progressive","prominent","promising","proper","proposed","prospective","protective","protestant","proud","provincial","psychiatric","psychological","public","puny","pure","purring","puzzled","quaint","qualified","quarrelsome","querulous","quick","quickest","quiet","quintessential","quixotic","racial","radical","rainy","random","rapid","rare","raspy","rational","ratty","raw","ready","real","realistic","rear","reasonable","recent","reduced","redundant","regional","registered","regular","regulatory","related","relative","relaxed","relevant","reliable","relieved","religious","reluctant","remaining","remarkable","remote","renewed","representative","repulsive","required","resident","residential","resonant","respectable","respective","responsible","resulting","retail","retired","revolutionary","rich","ridiculous","right","rigid","ripe","rising","rival","roasted","robust","rolling","romantic","rotten","rough","round","royal","rubber","rude","ruling","running","rural","sacred","sad","safe","salty","satisfactory","satisfied","scared","scary","scattered","scientific","scornful","scrawny","screeching","secondary","secret","secure","select","selected","selective","selfish","semantic","senior","sensible","sensitive","separate","serious","severe","sexual","shaggy","shaky","shallow","shared","sharp","sheer","shiny","shivering","shocked","short","shrill","shy","sick","significant","silent","silky","silly","similar","simple","single","skilled","skinny","sleepy","slight","slim","slimy","slippery","slow","small","smart","smiling","smoggy","smooth","social","socialist","soft","solar","sole","solid","sophisticated","sore","sorry","sound","sour","southern","soviet","spare","sparkling","spatial","special","specific","specified","spectacular","spicy","spiritual","splendid","spontaneous","sporting","spotless","spotty","square","squealing","stable","stale","standard","static","statistical","statutory","steady","steep","sticky","stiff","still","stingy","stormy","straight","straightforward","strange","strategic","strict","striking","striped","strong","structural","stuck","stupid","subjective","subsequent","substantial","subtle","successful","successive","sudden","sufficient","suitable","sunny","super","superb","superior","supporting","supposed","supreme","sure","surprised","surprising","surrounding","surviving","suspicious","sweet","swift","symbolic","sympathetic","systematic","tall","tame","tart","tasteless","tasty","technical","technological","teenage","temporary","tender","tense","terrible","territorial","testy","then","theoretical","thick","thin","thirsty","thorough","thoughtful","thoughtless","thundering","tight","tiny","tired","top","tory","total","tough","toxic","traditional","tragic","tremendous","tricky","tropical","troubled","typical","ugliest","ugly","ultimate","unable","unacceptable","unaware","uncertain","unchanged","uncomfortable","unconscious","underground","underlying","unemployed","uneven","unexpected","unfair","unfortunate","unhappy","uniform","uninterested","unique","united","universal","unknown","unlikely","unnecessary","unpleasant","unsightly","unusual","unwilling","upper","upset","uptight","urban","urgent","used","useful","useless","usual","vague","valid","valuable","variable","varied","various","varying","vast","verbal","vertical","very","vicarious","vicious","victorious","violent","visible","visiting","visual","vital","vitreous","vivacious","vivid","vocal","vocational","voiceless","voluminous","voluntary","vulnerable","wandering","warm","wasteful","watery","weak","wealthy","weary","wee","weekly","weird","welcome","well","western","wet","whispering","whole","wicked","wide","widespread","wild","wilful","willing","willowy","wily","wise","wispy","wittering","witty","wonderful","wooden","working","worldwide","worried","worrying","worthwhile","worthy","written","wrong","xenacious","xenial","xenogeneic","xenophobic","xeric","xerothermic","yabbering","yammering","yappiest","yappy","yawning","yearling","yearning","yeasty","yelling","yelping","yielding","yodelling","young","youngest","youthful","ytterbic","yucky","yummy","zany","zealous","zeroth","zestful","zesty","zippy","zonal","zoophagous","zygomorphic","zygotic"],it=["aardvark","aardwolf","albatross","alligator","alpaca","amphibian","anaconda","angelfish","anglerfish","ant","anteater","antelope","antlion","ape","aphid","armadillo","asp","baboon","badger","bandicoot","barnacle","barracuda","basilisk","bass","bat","bear","beaver","bedbug","bee","beetle","bird","bison","blackbird","boa","boar","bobcat","bobolink","bonobo","booby","bovid","bug","butterfly","buzzard","camel","canid","canidae","capybara","cardinal","caribou","carp","cat","caterpillar","catfish","catshark","cattle","centipede","cephalopod","chameleon","cheetah","chickadee","chicken","chimpanzee","chinchilla","chipmunk","cicada","clam","clownfish","cobra","cockroach","cod","condor","constrictor","coral","cougar","cow","coyote","crab","crane","crawdad","crayfish","cricket","crocodile","crow","cuckoo","damselfly","deer","dingo","dinosaur","dog","dolphin","donkey","dormouse","dove","dragon","dragonfly","duck","eagle","earthworm","earwig","echidna","eel","egret","elephant","elk","emu","ermine","falcon","felidae","ferret","finch","firefly","fish","flamingo","flea","fly","flyingfish","fowl","fox","frog","galliform","gamefowl","gayal","gazelle","gecko","gerbil","gibbon","giraffe","goat","goldfish","goose","gopher","gorilla","grasshopper","grouse","guan","guanaco","guineafowl","gull","guppy","haddock","halibut","hamster","hare","harrier","hawk","hedgehog","heron","herring","hippopotamus","hookworm","hornet","horse","hoverfly","hummingbird","hyena","iguana","impala","jackal","jaguar","jay","jellyfish","junglefowl","kangaroo","kingfisher","kite","kiwi","koala","koi","krill","ladybug","lamprey","landfowl","lark","leech","lemming","lemur","leopard","leopon","limpet","lion","lizard","llama","lobster","locust","loon","louse","lungfish","lynx","macaw","mackerel","magpie","mammal","manatee","mandrill","marlin","marmoset","marmot","marsupial","marten","mastodon","meadowlark","meerkat","mink","minnow","mite","mockingbird","mole","mollusk","mongoose","monkey","moose","mosquito","moth","mouse","mule","muskox","narwhal","newt","nightingale","ocelot","octopus","opossum","orangutan","orca","ostrich","otter","owl","ox","panda","panther","parakeet","parrot","parrotfish","partridge","peacock","peafowl","pelican","penguin","perch","pheasant","pig","pigeon","pike","pinniped","piranha","planarian","platypus","pony","porcupine","porpoise","possum","prawn","primate","ptarmigan","puffin","puma","python","quail","quelea","quokka","rabbit","raccoon","rat","rattlesnake","raven","reindeer","reptile","rhinoceros","roadrunner","rodent","rook","rooster","roundworm","sailfish","salamander","salmon","sawfish","scallop","scorpion","seahorse","shark","sheep","shrew","shrimp","silkworm","silverfish","skink","skunk","sloth","slug","smelt","snail","snake","snipe","sole","sparrow","spider","spoonbill","squid","squirrel","starfish","stingray","stoat","stork","sturgeon","swallow","swan","swift","swordfish","swordtail","tahr","takin","tapir","tarantula","tarsier","termite","tern","thrush","tick","tiger","tiglon","toad","tortoise","toucan","trout","tuna","turkey","turtle","tyrannosaurus","unicorn","urial","vicuna","viper","vole","vulture","wallaby","walrus","warbler","wasp","weasel","whale","whippet","whitefish","wildcat","wildebeest","wildfowl","wolf","wolverine","wombat","woodpecker","worm","wren","xerinae","yak","zebra"];const nt=/^[a-z]{2,15}-[a-z]{2,15}(-[0-9]+)?$/;function Xe(){return us({dictionaries:[at,it],separator:"-",style:"lowerCase",length:2})}function gs(a,e){return`${a}-${e}`}function ot(a){const e=a.match(/^([a-z]{2,15}-[a-z]{2,15})(?:-[0-9]+)?$/);return e?e[1]:a}const He=new Set(at),Ke=new Set(it),hs=new Set;function Je(a){return!a||typeof a!="string"?!1:nt.test(a)||/^[a-z]{2,15}-[a-z]{2,15}-[a-z0-9]{4}$/.test(a)?!0:/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i.test(a)}function er(a){if(!a||typeof a!="string")return!1;if(hs.has(a))return!0;if(nt.test(a)){const s=ot(a).split("-");if(s.length===2){const[r,i]=s;if(He.has(r)&&Ke.has(i))return!0}}if(/^[a-z]{2,15}-[a-z]{2,15}-[a-z0-9]{4}$/.test(a)){const t=a.split("-");if(t.length===3){const[s,r]=t;if(He.has(s)&&Ke.has(r))return!0}}return!1}const ye=class ye{constructor(){g(this,"generatedIds",new Set);g(this,"MAX_TRACKED_IDS",1e4);g(this,"CLEANUP_THRESHOLD",5e3)}static getInstance(){return this.instance||(this.instance=new ye),this.instance}generateAgentId(){const e=`agent-${this.generateUniqueId()}`;return Ae(e)}generateSessionId(){const e=`sess_${this.generateUniqueId()}`;return xt(e)}generateMessageId(){const e=`msg_${this.generateUniqueId()}`;return Pt(e)}generateWorkspaceId(){const e=Xe(),t=this.resolveWorkspaceSlugCollision(e);return this.generatedIds.add(t),this.cleanupIfNeeded(),we(t)}registerWorkspaceId(e){if(!Je(e)){const s=Xe(),r=this.resolveWorkspaceSlugCollision(s);return this.generatedIds.add(r),this.cleanupIfNeeded(),we(r)}const t=this.resolveWorkspaceSlugCollision(e);return this.generatedIds.add(t),this.cleanupIfNeeded(),we(t)}resolveWorkspaceSlugCollision(e){if(!this.generatedIds.has(e))return e;const t=ot(e);let s=1;for(const r of this.generatedIds)if(r===t||r.startsWith(`${t}-`)){const i=r.match(new RegExp(`^${t}-(\\d+)$`));if(i){const n=parseInt(i[1],10);n>=s&&(s=n+1)}else r===t&&(s=Math.max(s,2))}return gs(t,s)}generateStreamId(){const e=`stream_${this.generateUniqueId()}`;return Ft(e)}generateToolCallId(){const e=`tool_${this.generateUniqueId()}`;return Ut(e)}generateThreadId(){const e=`thread_${this.generateUniqueId()}`;return Wt(e)}generateUserId(){const e=this.generateUniqueId();return Gt(e)}generateNoteId(){const e=this.generateUniqueId();return Bt(e)}generateUniqueId(){let e,t=0;const s=10;do if(e=Oe(),t++,t>s)throw new Error("Failed to generate unique ID after 10 attempts");while(this.generatedIds.has(e));return this.generatedIds.add(e),this.cleanupIfNeeded(),e}cleanupIfNeeded(){if(this.generatedIds.size>this.MAX_TRACKED_IDS){const e=Array.from(this.generatedIds);this.generatedIds=new Set(e.slice(-this.CLEANUP_THRESHOLD))}}isValidAgentId(e){return e.startsWith("agent-")?e.length===42:Vt(e)}isValidSessionId(e){return $t(e)}isValidMessageId(e){return zt(e)}isValidWorkspaceId(e){return Je(e)}parseAgentId(e){return this.isValidAgentId(e)?Ae(e):null}parseSessionId(e){return this.isValidSessionId(e)?Ae(e):null}formatIdForDisplay(e){return e.length>12?`${e.slice(0,8)}...`:e}extractUuid(e){const t=e.match(/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}/i);return t?t[0]:e}getTrackedIdCount(){return this.generatedIds.size}clearTrackedIds(){this.generatedIds.clear()}};g(ye,"instance");let Ne=ye;const ms=Ne.getInstance(),fs=ms,O=new xe("MemoryManager"),$=class ${constructor(){g(this,"resources",new WeakMap);g(this,"globalResources",new Set);g(this,"memoryCheckInterval",null);g(this,"lastMemoryUsage",0);g(this,"lastMemoryWarningTime",0);g(this,"MEMORY_WARNING_INTERVAL",6e4);this.startMemoryMonitoring(),O.info("MemoryManager initialized")}addResourceToOwner(e,t){let s=this.resources.get(e);s||(s=new Set,this.resources.set(e,s)),s.add(t)}static getInstance(){return $.instance||($.instance=new $),$.instance}reset(){this.globalResources.forEach(e=>{try{e.cleanup()}catch(t){O.error("Error cleaning up resource during reset:",t)}}),this.globalResources.clear(),this.lastMemoryUsage=0,this.memoryCheckInterval&&clearInterval(this.memoryCheckInterval),this.startMemoryMonitoring()}getMemoryReport(){const e=process.memoryUsage();return{currentUsage:e.heapUsed,peakUsage:Math.max(this.lastMemoryUsage*1024*1024,e.heapUsed),resourceCount:this.globalResources.size,heapUsed:e.heapUsed,heapTotal:e.heapTotal,external:e.external,rss:e.rss,collections:0}}forceCleanup(){this.globalResources.forEach(e=>{try{e.cleanup()}catch(t){O.error("Error during force cleanup:",t)}}),this.globalResources.clear()}startMemoryMonitoring(){this.memoryCheckInterval=setInterval(()=>{this.checkMemoryUsage()},3e4)}checkMemoryUsage(){if(typeof process<"u"&&process.memoryUsage){const t=process.memoryUsage().heapUsed/1024/1024;if(t>this.lastMemoryUsage*1.5&&t>100){const s=Date.now();s-this.lastMemoryWarningTime>=this.MEMORY_WARNING_INTERVAL&&(this.lastMemoryWarningTime=s,O.warn("Memory usage increased significantly",{current:`${t.toFixed(2)}MB`,previous:`${this.lastMemoryUsage.toFixed(2)}MB`})),this.detectLeaks()}this.lastMemoryUsage=t}}detectLeaks(){const e=Date.now(),t=[];return this.globalResources.forEach(s=>{e-s.created>3e5&&t.push(s)}),t.length>0&&O.warn("Potential memory leak detected",{oldResourceCount:t.length,types:t.map(s=>s.type)}),t.length}registerListener(e,t,s,r){e.addEventListener(t,s);const i=()=>{e.removeEventListener(t,s)},n={type:"listener",cleanup:i,created:Date.now()};return r?this.addResourceToOwner(r,n):this.globalResources.add(n),O.debug("Listener registered",{event:t,hasOwner:!!r}),i}registerTimer(e,t,s,r){const i=s==="timeout"?setTimeout(e,t):setInterval(e,t),n=()=>{s==="timeout"?clearTimeout(i):clearInterval(i)},o={type:"timer",cleanup:n,created:Date.now()};return r?this.addResourceToOwner(r,o):this.globalResources.add(o),O.debug("Timer registered",{type:s,delay:t,hasOwner:!!r}),n}registerSubscription(e,t){const s={type:"subscription",cleanup:e,created:Date.now()};t?this.addResourceToOwner(t,s):this.globalResources.add(s),O.debug("Subscription registered",{hasOwner:!!t})}cleanup(e){const t=this.resources.get(e);if(!t)return;let s=0;t.forEach(r=>{r.cleanup(),s++}),this.resources.delete(e),O.debug("Resources cleaned up",{count:s})}cleanupGlobal(){let e=0;this.globalResources.forEach(t=>{t.cleanup(),e++}),this.globalResources.clear(),O.info("Global resources cleaned up",{count:e})}getMemoryStats(){const e=process.memoryUsage(),t=this.detectLeaks();return{heap:e.heapUsed,external:e.external,leaks:t}}};g($,"instance");let De=$;const be=De.getInstance(),S={toolStart:/(?:\x1B\[\d+m)?üîß\s+(?:Tool call:\s+)?(.+?)(?:\x1B\[0m)?$/,toolDetail:/(?:[‚îî‚îú]‚îÄ\s+(.+)$|^\s{3,}(.+)$)/,toolResult:/(?:\x1B\[\d+m)?üìã\s+Tool result:\s+(.+?)(?:\x1B\[0m)?$/,toolSuccess:/[‚úì‚úî‚úÖ]\s+(.+)$/,toolError:/[‚ùå‚úó‚ùé]\s+(.+)$/,sessionInfo:/[Ss]ession:\s*([a-f0-9-]+)/,resumedSession:/üìÇ?\s*Resumed session/i,assistantMarker:/ü§ñ/,systemMarker:/üíª/,userMarker:/üë§/,thinkingMarker:/ü§î\s*Thinking/i,waitingMarker:/^‚è≥\s+Running/i,indexingProgress:/^Indexing:\s*\[.*\]\s*\d+%/,agentDigest:/<agent_digest>([\s\S]*?)<\/agent_digest>/,setupScript:/<setup_script\s+name="([^"]+)"\s+description="([^"]+)">([\s\S]*?)<\/setup_script>/};class ps{constructor(){g(this,"buffer","");g(this,"currentToolName",null);g(this,"currentToolId",null);g(this,"lastToolId",null);g(this,"currentToolParams",[]);g(this,"currentToolResultContent",[]);g(this,"inToolResult",!1);g(this,"inCodeBlock",!1);g(this,"codeBlockLanguage","");g(this,"codeBlockContent","");g(this,"characterBuffer","");g(this,"inCharacterMode",!1);g(this,"emittedToolIds",new Set)}parseChunk(e){if(this.isMarkerLine(e.trim())){const r=[];if(this.inToolResult&&this.currentToolResultContent.length>0){const o=this.currentToolResultContent.some(c=>c.startsWith("‚ùå")||c.startsWith("Error:")),u=this.currentToolResultContent.map(c=>c.replace(/^‚ùå\s*/,"").replace(/^Error:\s*/,"")).join(`
`);r.push({type:"tool_result",content:u,metadata:{toolId:this.currentToolId,isError:o}}),this.lastToolId=this.currentToolId,this.currentToolId=null,this.inToolResult=!1,this.currentToolResultContent=[]}const i=e.indexOf("ü§ñ"),n=e.substring(i+2);if(this.inCharacterMode=!0,this.characterBuffer="",n&&n.trim()&&n!==`
`){const o=n.replace(/^\n/,"");o&&(this.characterBuffer=o)}return r}if(this.inCharacterMode){if(e.trim()===""&&this.characterBuffer==="")return[];if(e.includes(`
`)&&this.characterBuffer.length>0){const r=e.substring(0,e.indexOf(`
`));r&&(this.characterBuffer+=r);const i=[];return this.characterBuffer.trim()&&i.push({type:"text",content:this.characterBuffer.trim()}),this.characterBuffer="",this.inCharacterMode=!1,this.buffer="",i}return this.characterBuffer+=e,[]}if(this.currentToolName&&e.includes("   ")&&e.includes(`
`)){const r=e.split(`
`).filter(i=>i.trim());for(const i of r)i.startsWith("   ")&&this.currentToolParams.push(i.trim());return[]}if(this.inToolResult&&e.includes(`
`)&&!e.startsWith("ü§ñ")){const r=e.includes("‚ùå")||e.includes("Error:"),n={type:"tool_result",content:e.split(`
`).filter(o=>o.trim()).map(o=>o.replace(/^‚ùå\s*/,"").replace(/^Error:\s*/,"")).join(`
`),metadata:{toolId:this.currentToolId,isError:r}};return this.lastToolId=this.currentToolId,this.currentToolId=null,this.inToolResult=!1,this.currentToolResultContent=[],[n]}this.buffer+=e;const t=[],s=this.buffer.split(`
`);this.buffer=s.pop()||"";for(const r of s){if(!r.trim())continue;const i=this.parseLine(r);i&&t.push(i)}return t}isMultilineStringContinuation(e){if(this.currentToolParams.length===0)return!1;if((this.currentToolParams[this.currentToolParams.length-1].match(/"/g)||[]).length%2===1)return!0;const r=this.currentToolParams.join(`
`);return!!((r.includes('"content"')||r.includes("content:"))&&r.match(/content:\s*"[^"]*$/))}parseToolParams(e){if(e.length===0)return{};const t=e.join(`
`).trim();if(t.startsWith("{")||t.startsWith("["))try{return JSON.parse(t)}catch{}if(e.some(n=>n.includes('"')&&n.includes(":"))||e.some(n=>n.trim()==="{"||n.trim()==="}"))try{const n=e.join(" ").replace(/\s+/g," ").trim();return JSON.parse(n)}catch{}if(e.some(n=>n.startsWith("content:")||n.includes('"content"'))){const n={};let o=null,u=[],c=!1;for(const l of e){const E=l.match(/^"?([a-zA-Z_][a-zA-Z0-9_]*)"?\s*:\s*(.*)$/);if(E&&!c){if(o){let m=u.join(`
`).trim();m.startsWith('"')&&m.endsWith('"')&&(m=m.slice(1,-1)),n[o]=m}o=E[1].replace(/"/g,""),u=[E[2]],o==="content"&&E[2].startsWith('"')&&!E[2].endsWith('"')&&(c=!0)}else o&&(u.push(l),c&&l.endsWith('"')&&(c=!1))}if(o){let l=u.join(`
`).trim();l.startsWith('"')&&l.endsWith('"')?l=l.slice(1,-1):l.startsWith('"')&&(l=l.slice(1)),n[o]=l}return n}const i={};for(const n of e){const o=n.indexOf(":");if(o>0){const u=n.substring(0,o).trim();let c=n.substring(o+1).trim();(c.startsWith('"')&&c.endsWith('"')||c.startsWith("'")&&c.endsWith("'"))&&(c=c.slice(1,-1)),i[u]=c}}return i}isStreamingFragment(e){const t=e.trim();return t.length<10&&!this.isMarkerLine(e)&&!S.toolDetail.test(e)&&!S.toolSuccess.test(e)&&!S.toolError.test(e)&&!(t.split(/\s+/).length>3)}isMarkerLine(e){const t=e.trim();return t==="ü§ñ"||t==="üîß"||t==="üíª"||t==="üë§"||t==="ü§î"||t==="‚è≥"||S.assistantMarker.test(e)||S.systemMarker.test(e)||S.userMarker.test(e)}parseLine(e){if(!e.trim()&&!this.inCodeBlock||this.isStreamingFragment(e)&&!this.isMarkerLine(e))return null;const t=e.replace(/\x1B\[\d+m/g,"").replace(/\x1B\[0m/g,"");if(t.startsWith("```"))if(this.inCodeBlock){this.inCodeBlock=!1;const c=`\`\`\`${this.codeBlockLanguage}
${this.codeBlockContent}
\`\`\``;return this.codeBlockContent="",this.codeBlockLanguage="",{type:"text",content:c}}else return this.inCodeBlock=!0,this.codeBlockLanguage=e.slice(3).trim(),this.codeBlockContent="",null;if(this.inCodeBlock)return this.codeBlockContent+=(this.codeBlockContent?`
`:"")+e,null;const s=t.match(S.sessionInfo);if(s)return{type:"session_info",content:t,metadata:{sessionId:s[1]}};if(S.resumedSession.test(t))return{type:"session_info",content:t};const r=t.match(S.agentDigest);if(r){const c=r[1].trim();return c?{type:"digest",content:c}:null}const i=t.match(S.toolStart);if(i){let c=i[1];return c.startsWith("Tool call:")&&(c=c.replace("Tool call:","").trim()),c=c.replace(/\x1B\[\d+m/g,"").replace(/\x1B\[0m/g,""),this.currentToolName=c,this.currentToolId=`tool-${Date.now()}`,this.lastToolId=this.currentToolId,this.currentToolParams=[],null}if(t.match(S.toolResult)){if(this.currentToolName&&this.currentToolId){const c=[];if(!this.emittedToolIds.has(this.currentToolId)){const E={type:"tool_use",content:this.currentToolName,metadata:{toolName:this.currentToolName,toolId:this.currentToolId,toolInput:this.parseToolParams(this.currentToolParams)}};c.push(E),this.emittedToolIds.add(this.currentToolId)}const l=this.currentToolId;return this.currentToolName=null,this.currentToolId=l,this.currentToolParams=[],this.inToolResult=!0,this.currentToolResultContent=[],c.length>0?c[0]:null}return this.currentToolId=this.lastToolId,this.inToolResult=!0,this.currentToolResultContent=[],null}if(this.inToolResult){const c=t.match(S.toolStart),l=t.match(S.toolResult);if(this.isMarkerLine(t)||c||l){if(this.currentToolResultContent.length>0||this.inToolResult){const E=this.currentToolResultContent.some(p=>p.startsWith("‚ùå")||p.startsWith("Error:")),w={type:"tool_result",content:this.currentToolResultContent.map(p=>p.replace(/^‚ùå\s*/,"").replace(/^Error:\s*/,"")).join(`
`),metadata:{toolId:this.currentToolId,isError:E}};if(this.lastToolId=this.currentToolId,this.currentToolId=null,this.inToolResult=!1,this.currentToolResultContent=[],c){let p=c[1];p.startsWith("Tool call:")&&(p=p.replace("Tool call:","").trim()),p=p.replace(/\x1B\[\d+m/g,"").replace(/\x1B\[0m/g,""),this.currentToolName=p,this.currentToolId=`tool-${Date.now()}`,this.lastToolId=this.currentToolId,this.currentToolParams=[]}else l&&(this.currentToolId=this.lastToolId,this.inToolResult=!0,this.currentToolResultContent=[]);return w}this.inToolResult=!1,this.currentToolResultContent=[],this.lastToolId=this.currentToolId,this.currentToolId=null}else return this.currentToolResultContent.push(t),null}if(this.currentToolName){const c=e.startsWith("   "),l=this.isMultilineStringContinuation(e);if(c||l){const E=c?e.trim():e;return this.currentToolParams.push(E),null}}const o=e.match(S.toolSuccess);if(o){const c={type:"tool_result",content:o[1],metadata:{toolName:this.currentToolName,toolId:this.currentToolId,isError:!1}};return this.currentToolName=null,this.lastToolId=this.currentToolId,this.currentToolId=null,c}const u=e.match(S.toolError);if(u){const c={type:"tool_result",content:u[1],metadata:{toolName:this.currentToolName,toolId:this.currentToolId,isError:!0}};return this.currentToolName=null,this.lastToolId=this.currentToolId,this.currentToolId=null,c}if(S.assistantMarker.test(e)||S.systemMarker.test(e)||S.userMarker.test(e)||S.thinkingMarker.test(e)||S.waitingMarker.test(e)||S.indexingProgress.test(e))return null;if(this.currentToolName&&this.currentToolId&&!e.startsWith("   ")){if(!this.emittedToolIds.has(this.currentToolId)){const c={type:"tool_use",content:this.currentToolName,metadata:{toolName:this.currentToolName,toolId:this.currentToolId,toolInput:this.parseToolParams(this.currentToolParams)}};return this.emittedToolIds.add(this.currentToolId),this.currentToolName=null,this.lastToolId=this.currentToolId,this.currentToolId=null,this.currentToolParams=[],c}this.currentToolName=null,this.currentToolParams=[]}return{type:"text",content:t}}flush(){const e=[];if(this.inToolResult&&this.currentToolResultContent.length>0){const t=this.currentToolResultContent.some(r=>r.startsWith("‚ùå")||r.startsWith("Error:")),s=this.currentToolResultContent.map(r=>r.replace(/^‚ùå\s*/,"").replace(/^Error:\s*/,"")).join(`
`);e.push({type:"tool_result",content:s,metadata:{toolId:this.currentToolId,isError:t}})}if(this.characterBuffer.trim()&&e.push({type:"text",content:this.characterBuffer.trim()}),this.characterBuffer="",this.inCharacterMode=!1,this.buffer.trim()){const t=this.parseLine(this.buffer);t&&e.push(t)}return this.inCodeBlock&&this.codeBlockContent&&e.push({type:"text",content:`\`\`\`${this.codeBlockLanguage}
${this.codeBlockContent}
\`\`\``}),this.buffer="",this.inCodeBlock=!1,this.codeBlockContent="",this.codeBlockLanguage="",this.currentToolName=null,this.currentToolId=null,this.lastToolId=null,this.inToolResult=!1,this.currentToolResultContent=[],this.emittedToolIds.clear(),e}static extractDigest(e){const t=e.match(S.agentDigest);if(t){const s=t[1].trim(),r=e.replace(S.agentDigest,"").trim();return{digest:s||null,cleanedText:r}}return{digest:null,cleanedText:e}}static stripDigestTagsForDisplay(e){if(!e)return e;let t=e.replace(/<agent_digest>[\s\S]*?<\/agent_digest>/g,"");const s=t.lastIndexOf("<agent_digest>");s>=0&&t.lastIndexOf("</agent_digest>")<s&&(t=t.substring(0,s));const r=t.lastIndexOf("<");if(r>=0&&r>=t.length-20){const i=t.substring(r);("<agent_digest>".startsWith(i)||"</agent_digest>".startsWith(i))&&(t=t.substring(0,r))}return t}static extractSetupScript(e){const t=e.match(S.setupScript);return t?{name:t[1].trim(),description:t[2].trim(),content:t[3].trim()}:null}static toContentBlocks(e){var r,i,n;const t=[];let s="";for(const o of e)o.type==="text"?s+=(s?`
`:"")+o.content:(s&&(t.push({type:"text",text:s}),s=""),o.type==="tool_use"&&((r=o.metadata)!=null&&r.toolName)?t.push({type:"tool_use",id:o.metadata.toolId||`tool-${Date.now()}`,name:o.metadata.toolName,input:o.metadata.toolInput||{description:o.content}}):o.type==="tool_result"&&t.push({type:"tool_result",tool_use_id:((i=o.metadata)==null?void 0:i.toolId)||"",content:o.content,is_error:((n=o.metadata)==null?void 0:n.isError)||!1}));return s&&t.push({type:"text",text:s}),t}}const k=M("UnreadTrackingService"),Ze="augment:unread-agents",Qe="augment:unread-agents-workspaces",ys=100;class Es{constructor(){g(this,"currentlyViewedAgentId",null);g(this,"unreadAgents");g(this,"agentWorkspaceMap");g(this,"listeners",new Set);g(this,"agentExistsCallback",null);this.unreadAgents=this.loadFromStorage(),this.agentWorkspaceMap=this.loadWorkspaceMapFromStorage()}setAgentExistsCallback(e){this.agentExistsCallback=e}pruneStaleAgents(){if(!this.agentExistsCallback)return;const e=this.unreadAgents.size,t=[];for(const s of this.unreadAgents)this.agentExistsCallback(s)||t.push(s);if(t.length>0){for(const s of t)this.unreadAgents.delete(s);this.saveToStorage(),k.info("Pruned stale unread agent IDs",{before:e,after:this.unreadAgents.size,pruned:t.length})}}isLocalStorageAvailable(){return typeof localStorage<"u"}loadFromStorage(){if(!this.isLocalStorageAvailable())return new Set;try{const e=localStorage.getItem(Ze);if(e){const t=JSON.parse(e);if(Array.isArray(t))return k.debug("Loaded unread agents from storage",{count:t.length}),new Set(t)}}catch(e){k.warn("Failed to load unread agents from storage",e)}return new Set}loadWorkspaceMapFromStorage(){if(!this.isLocalStorageAvailable())return new Map;try{const e=localStorage.getItem(Qe);if(e){const t=JSON.parse(e);if(typeof t=="object"&&t!==null){const s=new Map(Object.entries(t));return k.debug("Loaded agent workspace map from storage",{count:s.size}),s}}}catch(e){k.warn("Failed to load agent workspace map from storage",e)}return new Map}saveToStorage(){if(this.isLocalStorageAvailable())try{const e=Array.from(this.unreadAgents);localStorage.setItem(Ze,JSON.stringify(e));const t={};for(const s of this.unreadAgents){const r=this.agentWorkspaceMap.get(s);r&&(t[s]=r)}localStorage.setItem(Qe,JSON.stringify(t))}catch(e){k.warn("Failed to save unread agents to storage",e)}}markAsViewed(e){e&&(this.currentlyViewedAgentId=e,this.unreadAgents.has(e)&&(this.unreadAgents.delete(e),this.saveToStorage(),k.debug("Agent marked as read",{agentId:e}),this.notifyListeners()))}clearCurrentlyViewed(){this.currentlyViewedAgentId=null}onNewAssistantMessage(e,t,s){if(e){if(s){k.debug("Skipping unread mark - background agent",{agentId:e});return}if(t&&this.agentWorkspaceMap.set(e,t),this.currentlyViewedAgentId===e){k.info("Skipping unread mark - agent is currently viewed",{agentId:e,currentlyViewedAgentId:this.currentlyViewedAgentId});return}if(this.unreadAgents.has(e))k.info("Agent already marked as unread",{agentId:e});else{if(this.unreadAgents.size>=ys){const i=this.unreadAgents.values().next().value;i&&(this.unreadAgents.delete(i),this.agentWorkspaceMap.delete(i),k.info("Removed oldest unread agent to stay within limit",{removed:i}))}this.unreadAgents.add(e),this.saveToStorage(),k.info("Agent marked as unread",{agentId:e,workspaceId:t,currentlyViewedAgentId:this.currentlyViewedAgentId,unreadCount:this.unreadAgents.size}),this.notifyListeners()}}}hasUnread(e){return this.unreadAgents.has(e)}getUnreadCount(){return this.unreadAgents.size}getUnreadAgentIds(){return Array.from(this.unreadAgents)}getUnreadAgentIdsForWorkspace(e){const t=[];for(const s of this.unreadAgents)this.agentWorkspaceMap.get(s)===e&&t.push(s);return t}getWorkspaceForAgent(e){return this.agentWorkspaceMap.get(e)}subscribe(e){return this.listeners.add(e),queueMicrotask(()=>{this.listeners.has(e)&&e(this.getUnreadCount())}),()=>this.listeners.delete(e)}clearUnread(e){this.unreadAgents.has(e)&&(this.unreadAgents.delete(e),this.agentWorkspaceMap.delete(e),this.saveToStorage(),this.notifyListeners()),this.currentlyViewedAgentId===e&&(this.currentlyViewedAgentId=null)}clearUnreadForWorkspace(e){const t=this.getUnreadAgentIdsForWorkspace(e);if(t.length!==0){for(const s of t)this.unreadAgents.delete(s),this.agentWorkspaceMap.delete(s);this.saveToStorage(),k.debug("Cleared unread agents for workspace",{workspaceId:e,count:t.length}),this.notifyListeners()}}clearAll(){this.unreadAgents.clear(),this.agentWorkspaceMap.clear(),this.saveToStorage(),this.currentlyViewedAgentId=null,this.notifyListeners()}notifyListeners(){const e=this.getUnreadCount();for(const t of this.listeners)try{t(e)}catch(s){k.error("Error in unread listener",s)}}}const Is=new Es,y=new xe("DirectStreamManager"),A={CLEANUP_INTERVAL:qe.COMPLETION_DETECTION_MS,SESSION_TIMEOUT:qe.BACKEND_STREAM_TIMEOUT_MS,RECOVERY_TIMEOUT:5e3,STALLED_TIMEOUT:3e4,TIMEOUT:1e4,MAX_SESSIONS:10,MAX_CHUNK_SIZE:256*1024,MAX_CHUNKS_BEFORE_PRUNE:200,MAX_CHUNKS_AFTER_PRUNE:50,MAX_SESSION_BYTES:10*1024*1024,HEALTH_CHECK_INTERVAL:3e4},z=class z extends ls{constructor(){super();g(this,"sessions",new Map);g(this,"callbacks",new Map);g(this,"cleanupInterval",null);g(this,"healthCheckInterval",null);g(this,"disposed",!1);g(this,"metrics",{activeStreams:0,totalStreams:0,totalChunks:0,totalBytes:0,averageResponseTime:0,memoryUsage:0,errors:0,recoveries:0});this.startCleanupInterval(),this.startHealthMonitoring(),this.loadFromSessionStorage()}static getInstance(){return z.instance||(z.instance=new z),z.instance}startStream(t,s){this.cleanupSessionByAgentId(t.agentId),this.sessions.size>=A.MAX_SESSIONS&&this.cleanupOldestSession();const r=fs.generateStreamId();y.info("Starting stream",{agentId:t.agentId,streamId:r,sessionId:t.sessionId});const i={streamId:r,config:t,startTime:Date.now(),lastActivity:Date.now(),chunks:[],accumulatedText:"",contentBlocks:[],isComplete:!1,listeners:new Set,timers:new Set,isActive:!0,chunksReceived:0,bytesReceived:0,sequenceNumber:0,expectedSequence:0,lastHealthCheck:Date.now(),healthStatus:"healthy",recoveryAttempts:0};this.sessions.set(t.agentId,i),s&&this.callbacks.set(t.agentId,s),this.metrics.activeStreams++,this.metrics.totalStreams++;const n=h.currentWorkspace;return n&&h.setStreaming(n.workspace.id,t.agentId,!0),this.emit("stream:start",{streamId:r,config:t}),y.info("Started stream",{agentId:t.agentId,streamId:r}),t.agentId}getSession(t){const s=this.sessions.get(t);if(s)return s;for(const r of this.sessions.values())if(r.config.sessionId===t||r.streamId===t)return r;return null}addTextChunk(t,s,r){const i=this.getSession(t);if(!i||i.isComplete){y.warn("Invalid or completed stream",{id:t});return}s.length>A.MAX_CHUNK_SIZE&&(y.warn("Chunk size exceeds limit",{id:t,size:s.length,limit:A.MAX_CHUNK_SIZE}),s=s.substring(0,A.MAX_CHUNK_SIZE));const n={type:"text",data:s,timestamp:Date.now(),sequence:r??i.sequenceNumber++};this.processChunk(i,n),r!==void 0&&r===i.expectedSequence&&i.expectedSequence++,i.chunksReceived++,i.bytesReceived+=s.length,i.lastActivity=Date.now(),this.metrics.totalChunks++,this.metrics.totalBytes+=s.length,i.chunksReceived%50===0&&this.saveToSessionStorage();const o=this.callbacks.get(i.config.agentId);if(o!=null&&o.onChunk)try{o.onChunk(s)}catch(u){y.error("Error in onChunk callback",{error:u})}}processChunk(t,s){var r;if(t.chunks.push(s),t.chunks.length%50===0&&t.chunks.length>A.MAX_CHUNKS_BEFORE_PRUNE&&this.pruneOldChunks(t),s.type==="text"){t.accumulatedText+=s.data;const i=2*1024*1024;t.chunks.length%100===0&&t.accumulatedText.length>i&&y.warn("Large streaming response detected",{agentId:t.config.agentId,accumulatedTextMB:(t.accumulatedText.length/(1024*1024)).toFixed(2),chunkCount:t.chunks.length});const n=h.currentWorkspace;if(n){let u=(((r=n.agents.get(t.config.agentId))==null?void 0:r.streaming.buffer)||"")+s.data;const{digest:c,cleanedText:l}=ps.extractDigest(u);c&&(u=l,h.updateAgentDigest(n.workspace.id,t.config.agentId,c),y.debug("Extracted agent digest from stream",{agentId:t.config.agentId,digest:c})),h.updateStreamBuffer(n.workspace.id,t.config.agentId,u)}}this.emit("stream:chunk",{streamId:t.streamId,chunk:s}),this.emit(`stream:${t.streamId}:chunk`,s)}addContentBlock(t,s){const r=this.getSession(t);if(!r||r.isComplete){y.warn("Invalid or completed stream",{streamId:t});return}const i={type:"content_block",data:s,timestamp:Date.now()};r.chunks.push(i),r.contentBlocks.push(s),r.lastActivity=Date.now();const n=h.currentWorkspace,o=n==null?void 0:n.agents.get(r.config.agentId);o&&o.streaming.active&&o.streaming.contentBlocks.push(s),this.emit("stream:content_block",{streamId:t,block:s}),this.emit(`stream:${t}:content_block`,s)}addToolCall(t,s){const r=this.getSession(t);if(!r||r.isComplete)return;const i={type:"tool_call",data:s,timestamp:Date.now()};r.chunks.push(i),r.lastActivity=Date.now();const n={type:"tool_use",id:s.id||Ve(Oe()),name:s.name,input:s.input};r.contentBlocks.push(n),this.emit("stream:tool_call",{streamId:t,toolCall:s}),this.emit(`stream:${t}:tool_call`,s)}startHealthMonitoring(){const t=be.registerTimer(()=>this.checkStreamHealth(),A.HEALTH_CHECK_INTERVAL,"interval",this);this.healthCheckInterval={cleanup:t}}checkStreamHealth(){const t=Date.now();for(const[s,r]of this.sessions){if(r.isComplete)continue;const i=t-r.lastActivity;t-r.lastHealthCheck,i>A.STALLED_TIMEOUT?r.healthStatus!=="stalled"&&(r.healthStatus="stalled",y.warn("Stream stalled",{streamId:s,timeSinceActivity:i,agentId:r.config.agentId}),this.attemptStreamRecoveryInternal(s)):i>A.STALLED_TIMEOUT/2?r.healthStatus="degraded":r.healthStatus="healthy",r.lastHealthCheck=t,(r.chunks.length>A.MAX_CHUNKS_BEFORE_PRUNE||r.bytesReceived>A.MAX_SESSION_BYTES)&&(y.warn("Stream approaching memory limits, pruning",{streamId:s,chunkCount:r.chunks.length,bytesReceived:r.bytesReceived,maxChunks:A.MAX_CHUNKS_BEFORE_PRUNE,maxBytes:A.MAX_SESSION_BYTES}),this.pruneOldChunks(r))}this.updateMetrics()}async attemptStreamRecovery(t){const s=this.sessions.get(t);if(!s)return!1;s.error&&(s.error=void 0,s.isComplete=!1,s.isActive=!0,s.healthStatus="recovering"),await this.attemptStreamRecoveryInternal(t);const r=this.sessions.get(t);return r?r.healthStatus!=="stalled"&&r.healthStatus!=="error"&&!r.isComplete:!1}async attemptStreamRecoveryInternal(t){const s=this.sessions.get(t);if(!s||s.isComplete)return;if(s.recoveryAttempts++,s.recoveryAttempts>3){y.error("Stream recovery failed after 3 attempts",{streamId:t});const i=new Error("Stream stalled and recovery failed");this.handleError(t,i);return}y.info("Attempting stream recovery",{streamId:t,attempt:s.recoveryAttempts}),this.emit("stream:recovery",{streamId:t,attempt:s.recoveryAttempts}),s.healthStatus="recovering",s.lastActivity=Date.now(),s.error||(s.healthStatus="healthy");const r=setTimeout(()=>{const i=this.sessions.get(t);i&&i.healthStatus==="degraded"&&this.attemptStreamRecoveryInternal(t)},A.RECOVERY_TIMEOUT);s.timers.add(r),this.metrics.recoveries++}pruneOldChunks(t){const s=A.MAX_CHUNKS_AFTER_PRUNE;if(t.chunks.length>s){const r=t.chunks.length,i=t.chunks.splice(0,t.chunks.length-s),n=t.bytesReceived/r,o=Math.floor(n*i.length);t.bytesReceived=Math.max(0,t.bytesReceived-o),y.info("Pruned old chunks to reduce memory pressure",{streamId:t.streamId,removed:i.length,remaining:t.chunks.length,estimatedBytesFreed:o,newBytesReceived:t.bytesReceived})}}async completeStream(t){var Y;const s=this.getSession(t);if(!s)return{success:!1,error:"Stream session not found"};if(s.isComplete)return{success:!1,error:"Stream already completed"};s.isComplete=!0,s.isActive=!1;const r=Date.now()-s.startTime,i={id:s.config.messageId||Ve(Oe()),role:"assistant",contentBlocks:s.contentBlocks.length>0?s.contentBlocks:s.accumulatedText?[{type:"text",text:s.accumulatedText}]:[],timestamp:new Date,metadata:{streamId:s.streamId,duration:r,chunkCount:s.chunks.length,bytesReceived:s.bytesReceived,healthStatus:s.healthStatus,recoveryAttempts:s.recoveryAttempts}};if(i.contentBlocks&&i.contentBlocks.length>0){const C=i.contentBlocks.filter(de=>de.type==="text").map(de=>de.text||de.content||"").join("");i.content=C}else i.content=s.accumulatedText||"";const n=h.currentWorkspace;n&&h.setStreaming(n.workspace.id,s.config.agentId,!1);const o=this.callbacks.get(s.config.agentId);if(o!=null&&o.onComplete)try{o.onComplete(i)}catch(C){y.error("Error in onComplete callback",{error:C})}if(s.config.onComplete)try{s.config.onComplete()}catch(C){y.error("Error in config onComplete callback",{error:C})}this.emit("stream:complete",{streamId:s.streamId,message:i}),this.emit(`stream:${s.streamId}:complete`,i);const u=h.getAgentsForWorkspace(s.config.workspaceId).find(C=>C.id===s.config.agentId),c=(u==null?void 0:u.isBackground)||((Y=u==null?void 0:u.metadata)==null?void 0:Y.isBackground)||!1;Is.onNewAssistantMessage(s.config.agentId,s.config.workspaceId,c),this.metrics.activeStreams--;const l=r,E=this.metrics.averageResponseTime,m=this.metrics.totalStreams;this.metrics.averageResponseTime=(E*(m-1)+l)/m;const w=s.accumulatedText.length,p=s.contentBlocks.length,v=s.chunks.length,P=s.bytesReceived,d=s.healthStatus,X=s.accumulatedText,Ee=[...s.contentBlocks];y.info("Completed stream",{streamId:s.streamId,duration:r,textLength:w,blockCount:p,chunkCount:v,bytesReceived:P,healthStatus:d}),s.accumulatedText="",s.chunks=[];const le=setTimeout(()=>{this.cleanupSession(s.config.agentId)},5e3);return s.timers.add(le),{success:!0,message:i,text:X,contentBlocks:Ee,duration:r,chunkCount:v,bytesReceived:P,healthStatus:d}}handleError(t,s){const r=this.getSession(t);if(!r)return;r.error=s,r.isComplete=!0,r.isActive=!1,r.healthStatus="error";const i=h.currentWorkspace;if(i){h.setStreaming(i.workspace.id,r.config.agentId,!1);const o=i.agents.get(r.config.agentId);o&&o.errors.push(s)}const n=this.callbacks.get(r.config.agentId);if(n!=null&&n.onError)try{n.onError(s)}catch(o){y.error("Error in onError callback",{error:o})}this.emit("stream:error",{streamId:r.streamId,error:s}),this.emit(`stream:${r.streamId}:error`,s),this.metrics.errors++,this.metrics.activeStreams=Math.max(0,this.metrics.activeStreams-1),y.error("Stream error",{streamId:r.streamId,error:s.message,agentId:r.config.agentId}),r.markedForCleanup=!0}cleanupSession(t){const s=this.sessions.get(t);s&&(y.info("Cleaning up stream session",{agentId:s.config.agentId,listenersCount:s.listeners.size,timersCount:s.timers.size}),s.listeners.forEach(r=>{try{r()}catch(i){y.error("Error during listener cleanup",{error:i})}}),s.listeners.clear(),s.timers.forEach(r=>{try{clearTimeout(r)}catch(i){y.error("Error clearing timer",{error:i})}}),s.timers.clear(),this.callbacks.delete(s.config.agentId),this.sessions.delete(s.config.agentId))}cleanupSessionByAgentId(t){this.sessions.has(t)&&this.cleanupSession(t)}isActive(t){const s=this.sessions.get(t);return s?!s.isComplete:!1}getActiveStreams(){return Array.from(this.sessions.values()).filter(t=>!t.isComplete)}cancelStream(t){const s=this.getSession(t);if(!s||s.isComplete)return;const r=new Error("Stream cancelled by user");this.handleError(t,r)}forceCloseStream(t){const s=this.getSession(t);if(s){s.isComplete=!0,s.isActive=!1;for(const r of s.timers)clearTimeout(r);s.timers.clear(),s.listeners.clear(),this.sessions.delete(s.config.agentId),this.callbacks.delete(s.config.agentId)}}registerCleanup(t,s){const r=this.getSession(t);r&&r.listeners.add(s)}registerTimer(t,s){const r=this.getSession(t);r&&r.timers.add(s)}updateActivity(t){const s=this.getSession(t);s&&(s.lastActivity=Date.now())}updateMetrics(){if(typeof process<"u"&&typeof process.memoryUsage=="function"){const t=process.memoryUsage();this.metrics.memoryUsage=t.heapUsed}else if(typeof performance<"u"&&typeof performance.memory<"u"){const t=performance.memory;t&&t.usedJSHeapSize?this.metrics.memoryUsage=t.usedJSHeapSize:this.metrics.memoryUsage=this.estimateMemoryUsage()}else this.metrics.memoryUsage=this.estimateMemoryUsage();this.metrics.activeStreams=Array.from(this.sessions.values()).filter(t=>!t.isComplete).length}estimateMemoryUsage(){let t=0;for(const s of this.sessions.values())t+=s.accumulatedText.length*2,t+=s.chunks.length*100,t+=s.bytesReceived;return t}getMetrics(){return this.updateMetrics(),{...this.metrics}}getStreamHealth(t){const s=this.getSession(t);if(!s)return{status:"not_found"};const i=Date.now()-s.lastActivity;return s.error?{status:"error",lastActivity:s.lastActivity,error:s.error}:s.isComplete?{status:"completed",lastActivity:s.lastActivity}:i>A.TIMEOUT?{status:"stalled",lastActivity:s.lastActivity}:s.isActive?{status:"active",lastActivity:s.lastActivity}:{status:"idle",lastActivity:s.lastActivity}}startCleanupInterval(){const t=be.registerTimer(()=>this.cleanupTimedOutSessions(),A.CLEANUP_INTERVAL,"interval",this);this.cleanupInterval={cleanup:t}}cleanupStalledStreams(){const t=Date.now();for(const[s,r]of this.sessions){const i=t-r.lastActivity;i>A.TIMEOUT&&!r.isComplete&&(y.warn("Cleaning up stalled stream",{streamId:s,timeSinceActivity:i,agentId:r.config.agentId}),this.cleanupSession(s))}}cleanupTimedOutSessions(){const t=Date.now(),s=A.SESSION_TIMEOUT,r=300*1e3;for(const[i,n]of this.sessions)if(!n.isComplete&&t-n.lastActivity>s){y.warn("Cleaning up timed out session",{streamId:i,agentId:n.config.agentId,inactiveDuration:t-n.lastActivity});const o=new Error("Stream timed out");this.handleError(i,o)}else n.markedForCleanup&&t-n.lastActivity>1e3?(y.info("Cleaning up marked session",{streamId:i,agentId:n.config.agentId}),this.cleanupSession(i)):n.isComplete&&t-n.lastActivity>r&&(y.info("Cleaning up stale completed session",{streamId:i,agentId:n.config.agentId}),this.cleanupSession(i))}cleanupOldestSession(){let t=null,s=null;for(const[r,i]of this.sessions){if(i.isComplete){this.cleanupSession(r);return}(!t||i.startTime<t.startTime)&&(t=i,s=r)}s&&(y.warn("Cleaning up oldest session due to limit",{streamId:s}),this.cancelStream(s))}cleanupAll(){y.info("Cleaning up all streaming sessions",{count:this.sessions.size});for(const t of Array.from(this.sessions.keys()))this.cleanupSession(t);this.callbacks.clear()}cleanup(){this.cleanupAll(),this.metrics={activeStreams:0,totalStreams:0,totalChunks:0,totalBytes:0,averageResponseTime:0,memoryUsage:0,errors:0,recoveries:0}}flushBatch(){}destroy(){this.cleanupInterval&&(typeof this.cleanupInterval=="object"&&"cleanup"in this.cleanupInterval?this.cleanupInterval.cleanup():clearInterval(this.cleanupInterval),this.cleanupInterval=null),this.healthCheckInterval&&(typeof this.healthCheckInterval=="object"&&"cleanup"in this.healthCheckInterval?this.healthCheckInterval.cleanup():clearInterval(this.healthCheckInterval),this.healthCheckInterval=null);for(const t of this.sessions.keys())this.cancelStream(t);this.cleanupAll(),this.removeAllListeners()}async testStreaming(t,s={}){const r={agentId:"test-agent",sessionId:"test-session",workspaceId:"test-workspace"},i=this.startStream(r),n=s.delay||100;for(const o of t)this.addTextChunk(i,o),await new Promise(u=>setTimeout(u,n));return this.completeStream(i)}async testErrorRecovery(t){const s={agentId:"test-agent-recovery",sessionId:"test-session-recovery",workspaceId:"test-workspace"},r=this.startStream(s);if(t.type==="stream-interruption"){const i=this.sessions.get(r);if(i){i.lastActivity=Date.now()-A.STALLED_TIMEOUT-1e3,i.healthStatus="stalled",await this.attemptStreamRecovery(r),await new Promise(o=>setTimeout(o,1e3));const n=this.sessions.get(r);return n?n.healthStatus!=="stalled":!1}}return!1}static generateLargeChunks(t){const s=[];for(let r=0;r<t;r++)s.push(`Chunk ${r}: ${Math.random().toString(36).substring(2,15)}`);return s}saveToSessionStorage(){if(!(typeof sessionStorage>"u"))try{const t=Array.from(this.sessions.entries()).filter(([,s])=>!s.isComplete&&s.isActive).map(([s,r])=>({streamId:s,config:r.config,startTime:r.startTime,lastActivity:r.lastActivity,accumulatedText:r.accumulatedText,contentBlocks:r.contentBlocks,chunksReceived:r.chunksReceived,bytesReceived:r.bytesReceived,sequenceNumber:r.sequenceNumber,healthStatus:r.healthStatus}));t.length>0?(sessionStorage.setItem("active-streams",JSON.stringify(t)),y.info("Saved active streams to sessionStorage",{count:t.length,agentIds:t.map(s=>s.config.agentId)})):sessionStorage.removeItem("active-streams")}catch(t){y.error("Failed to save streams to sessionStorage",{error:t})}}loadFromSessionStorage(){if(!(typeof sessionStorage>"u"))try{const t=sessionStorage.getItem("active-streams");if(!t){y.debug("No active streams found in sessionStorage");return}const s=JSON.parse(t);y.info("Loading streams from sessionStorage",{count:s.length});for(const r of s){const i=Date.now()-r.lastActivity;if(i>300*1e3){y.warn("Skipping stale stream from sessionStorage",{agentId:r.config.agentId,ageMinutes:Math.round(i/6e4)});continue}const n={streamId:r.streamId,config:r.config,startTime:r.startTime,lastActivity:Date.now(),chunks:[],accumulatedText:r.accumulatedText,contentBlocks:r.contentBlocks,isComplete:!1,isActive:!0,listeners:new Set,timers:new Set,chunksReceived:r.chunksReceived,bytesReceived:r.bytesReceived,sequenceNumber:r.sequenceNumber,expectedSequence:r.sequenceNumber,lastHealthCheck:Date.now(),healthStatus:"degraded",recoveryAttempts:0};this.sessions.set(r.config.agentId,n);const o=h.currentWorkspace;if(o&&(h.setStreaming(o.workspace.id,r.config.agentId,!0),r.contentBlocks.length>0)){const u=o.agents.get(r.config.agentId);if(u!=null&&u.session){const c=u.session.messages[u.session.messages.length-1];c&&c.role==="assistant"?c.contentBlocks=[...c.contentBlocks||[],...r.contentBlocks]:h.addMessage(o.workspace.id,r.config.agentId,{id:`msg_${Date.now()}`,role:"assistant",contentBlocks:r.contentBlocks,timestamp:new Date})}}y.info("Restored stream from sessionStorage",{streamId:r.streamId,agentId:r.config.agentId,textLength:r.accumulatedText.length,blocksCount:r.contentBlocks.length}),this.emit("stream:reconnecting",{streamId:r.streamId,agentId:r.config.agentId})}sessionStorage.removeItem("active-streams")}catch(t){y.error("Failed to load streams from sessionStorage",{error:t})}}dispose(){this.disposed||(this.disposed=!0,y.info("Disposing StreamManager"),this.saveToSessionStorage(),this.destroy(),be.cleanup(this),y.info("StreamManager disposed successfully"))}};g(z,"instance");let pe=z;pe.getInstance();const R=M("browser/index"),Pe=kt({sessions:[]}),te=new Map,ge=new Set;let me=!1,se=null,B;function Ss(a,e){var i,n;let t=te.get(a);t||(t=new Set,te.set(a,t)),t.add(e);let s=null;const r=h.currentWorkspace;if(s=r==null?void 0:r.agents.get(a),!s){const o=h.getAllWorkspaces();for(const u of o)if(s=u.agents.get(a),s)break}if(s!=null&&s.session){const o={...s.session,messages:s.messages||s.session.messages||[]};R.debug("[subscribeToAgent] DIAGNOSTIC: Initial callback data",{agentId:a,hasSession:!0,sessionHasMetadata:!!s.session.metadata,sessionMetadataSpecialist:((i=s.session.metadata)==null?void 0:i.specialist)||"NONE",agentStateHasMetadata:!!s.metadata,agentStateMetadataSpecialist:((n=s.metadata)==null?void 0:n.specialist)||"NONE"}),e(o)}else R.debug("[subscribeToAgent] DIAGNOSTIC: No session found",{agentId:a}),e(void 0);return()=>{const o=te.get(a);o&&(o.delete(e),o.size===0&&te.delete(a))}}function ct(a,e){var i;const t=te.get(a);if(!t||t.size===0)return;let s=null;if(e){const n=h.getWorkspace(e);s=n==null?void 0:n.agents.get(a)}if(!s){const n=h.currentWorkspace;s=n==null?void 0:n.agents.get(a)}if(!s){const n=h.getAllWorkspaces();for(const o of n)if(s=o.agents.get(a),s)break}const r=s!=null&&s.session?{...s.session,messages:s.messages||s.session.messages||[]}:void 0;R.debug("[notifyAgentSubscribers] DIAGNOSTIC: Notifying with session",{agentId:a,hasSession:!!r,sessionHasMetadata:!!(r!=null&&r.metadata),sessionMetadataSpecialist:((i=r==null?void 0:r.metadata)==null?void 0:i.specialist)||"NONE",subscriberCount:t.size});for(const n of t)try{n(r)}catch(o){R.error("Error in agent subscriber callback",{agentId:a,error:o})}}function b(a,e){var t,s,r,i;e&&ge.add(e),a?B=a:B||(B=(s=(t=h.currentWorkspace)==null?void 0:t.workspace)==null?void 0:s.id),!me&&(me=!0,R.debug("Scheduling store update",{forWorkspaceId:a,pendingTargetWorkspaceId:B,currentWorkspaceId:(i=(r=h.currentWorkspace)==null?void 0:r.workspace)==null?void 0:i.id,pendingAgentCount:ge.size}),se=requestAnimationFrame(()=>{me=!1,se=null;const n=B;B=void 0;const o=Array.from(ge);ge.clear();for(const c of o)ct(c,n);const u=h.getAllAgents();Pe.set({sessions:u})}))}let et=!1;function vs(){et||(et=!0,It(async()=>{const{unifiedStateStore:a}=await import("./CA0vlnYV.js").then(e=>e.b);return{unifiedStateStore:a}},__vite__mapDeps([0,1,2,3])).then(({unifiedStateStore:a})=>{a.onStreamingChange(()=>{b()})}).catch(a=>{R.error("Failed to set up streaming listener",{error:a})}))}function Ts(){se!==null&&(cancelAnimationFrame(se),se=null,me=!1,B=void 0)}const lt={getStore:()=>(vs(),Pe),getSession:a=>{var r;const e=h.currentWorkspace,t=e==null?void 0:e.agents.get(a);if(!(t!=null&&t.session))return;const s=((r=t.streaming)==null?void 0:r.active)??t.session.isStreaming??!1;return{...t.session,isStreaming:s,messages:t.messages&&t.messages.length>0?t.messages:t.session.messages&&t.session.messages.length>0?t.session.messages:[]}},getAllSessions:()=>{const a=h.currentWorkspace;if(!a)return[];const e=[];return a.agents.forEach(t=>{var s;if(t.session){const r=((s=t.streaming)==null?void 0:s.active)??t.session.isStreaming??!1,i={...t.session,isStreaming:r,messages:t.messages||t.session.messages||[]};e.push(i)}}),e},getAllSessionsAcrossWorkspaces:()=>{const a=[],e=h.getAllWorkspaces();for(const t of e)t.agents.forEach(s=>{var i,n;const r=((i=s.streaming)==null?void 0:i.active)??((n=s.session)==null?void 0:n.isStreaming)??!1;if(s.session&&r){const o={...s.session,isStreaming:r,messages:s.messages||s.session.messages||[]};a.push(o)}});return a},findSessions:a=>{const e=h.currentWorkspace;if(!e)return[];const t=[];return e.agents.forEach(s=>{if(s.session){const r={...s.session,messages:s.messages||s.session.messages||[]};a(r)&&t.push(r)}}),t},updateSession:(a,e)=>{var s;const t=h.currentWorkspace;if(t){const r=t.agents.get(a);r!=null&&r.session&&(Object.assign(r.session,e),e.messages&&Array.isArray(e.messages)&&(r.messages=e.messages),b((s=t.workspace)==null?void 0:s.id,a))}},addSession:a=>{var r,i;if(!a){R.warn("addSession called with null/undefined session, ignoring");return}const e=a.workspaceId,t=h.currentWorkspace,s=e||((r=t==null?void 0:t.workspace)==null?void 0:r.id);R.debug("sessionStore.addSession called",{sessionId:a==null?void 0:a.id,hasWorkspace:!!t,workspaceId:s,sessionWorkspaceId:e,currentWorkspaceId:(i=t==null?void 0:t.workspace)==null?void 0:i.id}),s?(h.setAgent(s,a),b(s,a.id)):R.warn("addSession: No target workspace ID available, session not added",{sessionId:a==null?void 0:a.id,sessionWorkspaceId:e,hasCurrentWorkspace:!!t})},removeSession:a=>{var t;const e=h.currentWorkspace;e&&(e.agents.delete(a),b((t=e.workspace)==null?void 0:t.id,a))},removeAgent:a=>{lt.removeSession(a)},setStreaming:(a,e)=>{var s;const t=h.currentWorkspace;if(t)R.info("sessionStore.setStreaming - updating unified state store",{agentId:a,isStreaming:e,workspaceId:t.workspace.id}),h.setStreaming(t.workspace.id,a,e),b((s=t.workspace)==null?void 0:s.id,a);else{const r=h.getAllWorkspaces();for(const i of r)if(i.agents.has(a)){R.info("sessionStore.setStreaming - found agent in workspace (fallback)",{agentId:a,isStreaming:e,workspaceId:i.workspace.id}),h.setStreaming(i.workspace.id,a,e),b(i.workspace.id,a);return}R.warn("sessionStore.setStreaming - Agent not found in any workspace",{agentId:a,isStreaming:e})}},setStreamingForWorkspace:(a,e,t)=>{R.info("sessionStore.setStreamingForWorkspace - updating unified state store",{agentId:e,isStreaming:t,workspaceId:a}),h.setStreaming(a,e,t),b(a,e)},getSessionForWorkspace:(a,e)=>h.getAgentsForWorkspace(a).find(s=>s.id===e),setActiveSession:a=>{const e=h.currentWorkspace;e&&h.setActiveAgent(e.workspace.id,a)},getActiveSession:()=>{var s;const a=h.currentWorkspace;if(!a||!a.activeAgentId)return;const e=a.agents.get(a.activeAgentId);if(!(e!=null&&e.session))return;const t=((s=e.streaming)==null?void 0:s.active)??e.session.isStreaming??!1;return{...e.session,isStreaming:t,messages:e.messages&&e.messages.length>0?e.messages:e.session.messages&&e.session.messages.length>0?e.session.messages:[]}},addMessage:(a,e)=>{var s;const t=h.currentWorkspace;t&&(h.addMessage(t.workspace.id,a,e),b((s=t.workspace)==null?void 0:s.id,a))},addMessageForWorkspace:(a,e,t)=>{var s;R.info("sessionStore.addMessageForWorkspace - adding message to specific workspace",{agentId:e,workspaceId:a,messageId:t==null?void 0:t.id,hasMetadata:!!(t!=null&&t.metadata),metadataType:(s=t==null?void 0:t.metadata)==null?void 0:s.type}),h.addMessage(a,e,t),b(a,e)},updateMessage:(a,e,t)=>{var r;const s=h.currentWorkspace;if(s){const i=s.agents.get(a);if(i){const n=i.messages.findIndex(o=>o.id===e);n!==-1&&(i.messages[n]={...i.messages[n],...t},i.session&&i.session.messages&&(i.session.messages[n]=i.messages[n]),b((r=s.workspace)==null?void 0:r.id,a))}}},updateMessageForWorkspace:(a,e,t,s)=>{const r=h.getAllWorkspaces().find(i=>i.workspace.id===a);if(r){const i=r.agents.get(e);if(i){const n=i.messages.findIndex(o=>o.id===t);n!==-1&&(i.messages[n]={...i.messages[n],...s},i.session&&i.session.messages&&(i.session.messages[n]=i.messages[n]),b(a,e))}}},updateMessages:(a,e)=>{var s;const t=h.currentWorkspace;if(t){const r=t.agents.get(a);r&&(r.messages=[...e],r.session&&(r.session.messages=[...e]),r.messageIdSet=new Set(e.map(i=>i.id)),b((s=t.workspace)==null?void 0:s.id,a))}},getStats:()=>{const a=h.currentWorkspace;if(!a)return{totalSessions:0,activeSessions:0,totalMessages:0};let e=0,t=0;return a.agents.forEach(s=>{s.session&&(s.streaming.active&&t++,e+=s.messages.length)}),{totalSessions:a.agents.size,activeSessions:t,totalMessages:e}},clear:()=>{const a=h.currentWorkspace;a&&a.agents.clear()}},f=M("AgentProxies");class dt{constructor(){g(this,"agentOperationMutex",new Map)}async createAgent(e){const t=(e==null?void 0:e.agentId)||(e==null?void 0:e.id);if(t){const s=this.agentOperationMutex.get(t);s&&(f.warn("createAgent blocked by in-flight operation, waiting...",{agentId:t,workspaceId:e==null?void 0:e.workspaceId,codePath:"AgentIpcProxy.createAgent"}),await s.catch(()=>{}));const r=this._doCreateAgent(e);this.agentOperationMutex.set(t,r);try{return await r}finally{this.agentOperationMutex.delete(t)}}return this._doCreateAgent(e)}async _doCreateAgent(e){var t,s,r,i,n,o,u,c,l,E,m,w,p,v,P;try{const d=await T(q.CREATE,e);return f.info("agent:create response:",{hasDirectSuccess:(d==null?void 0:d.success)!==void 0,hasDirectAgent:!!(d!=null&&d.agent),hasData:!!(d!=null&&d.data),dataType:typeof(d==null?void 0:d.data),hasDataAgent:!!((t=d==null?void 0:d.data)!=null&&t.agent),hasDataSuccess:((s=d==null?void 0:d.data)==null?void 0:s.success)!==void 0,directAgentWorkspaceId:(r=d==null?void 0:d.agent)==null?void 0:r.workspaceId,dataAgentWorkspaceId:(n=(i=d==null?void 0:d.data)==null?void 0:i.agent)==null?void 0:n.workspaceId,response:d}),(d==null?void 0:d.success)!==void 0&&(d!=null&&d.agent)?(f.info("Response has direct structure",{success:d.success,hasAgent:!!d.agent,agentId:(o=d.agent)==null?void 0:o.id,agentWorkspaceId:(u=d.agent)==null?void 0:u.workspaceId}),d):((c=d==null?void 0:d.data)==null?void 0:c.success)!==void 0?(f.info("Response wrapped in data property (legacy)",{success:d.data.success,hasAgent:!!((l=d.data)!=null&&l.agent),agentId:(m=(E=d.data)==null?void 0:E.agent)==null?void 0:m.id,agentWorkspaceId:(p=(w=d.data)==null?void 0:w.agent)==null?void 0:p.workspaceId}),d.data):(v=d==null?void 0:d.data)!=null&&v.agent?(f.warn("Wrapping agent in success structure for compatibility"),{success:!0,agent:d.data.agent}):(P=d==null?void 0:d.data)!=null&&P.id?(f.warn("Only agent ID returned, creating minimal agent object"),{success:!0,agent:{id:String(d.data.id),workspaceId:e.workspaceId,name:e.name||"Agent"}}):(f.error("Invalid response from agent:create - no agent found",d),{success:!1,error:"Failed to create agent - no agent returned"})}catch(d){return f.error("Failed to create agent:",d),{success:!1,error:d instanceof Error?d.message:"Unknown error"}}}async activateAgent(e,t){const s=this.agentOperationMutex.get(e);s&&(f.warn("activateAgent blocked by in-flight operation, waiting...",{agentId:e,workspaceId:t==null?void 0:t.id,codePath:"AgentIpcProxy.activateAgent"}),await s.catch(()=>{}));const r=this._doActivateAgent(e,t);this.agentOperationMutex.set(e,r);try{return await r}finally{this.agentOperationMutex.delete(e)}}async _doActivateAgent(e,t){var s,r,i,n;try{if(f.info("Activating agent",{agentId:e,agentIdType:typeof e,workspaceType:typeof t,hasWorkspace:!!t,workspaceId:t==null?void 0:t.id}),!(t!=null&&t.id)){const E="activateAgent called with invalid workspace - workspace ID is required";throw f.error(E,{agentId:e,workspace:t,hasWorkspace:!!t,workspaceKeys:t?Object.keys(t):[],stack:new Error().stack}),new Error(E)}const o=String(e),u=String(t.id),c={agentId:o,sessionId:o,workspaceId:u};f.info("IPC params for agent:activate",{params:c,paramsType:typeof c,paramsKeys:Object.keys(c)});const l=await T(q.ACTIVATE,c);if(f.info("Activation response received",{agentId:e,hasResponse:!!l,responseType:typeof l,responseKeys:l?Object.keys(l):[],hasData:!!(l!=null&&l.data),dataType:l!=null&&l.data?typeof l.data:"undefined",hasBackendSessionId:!!((s=l==null?void 0:l.data)!=null&&s.backendSessionId),backendSessionId:(r=l==null?void 0:l.data)==null?void 0:r.backendSessionId,hasAgent:!!((i=l==null?void 0:l.data)!=null&&i.agent),fullResponse:l}),!l)return f.error("No response received from agent activation"),null;if(l.id&&l.workspaceId)return f.info("Response is agent directly",{agentId:l.id}),l;if(!l.data)return f.error("Response has no data property and is not an agent",{response:l}),null;if(l.data.agent){const E=l.data.agent;return l.data.backendSessionId&&(E.backendSessionId=l.data.backendSessionId,E.id=l.data.backendSessionId),f.info("Returning activated agent with updated sessionId",{agentId:E.id,backendSessionId:E.backendSessionId,messageCount:((n=E.messages)==null?void 0:n.length)||0,hasMessages:!!E.messages,messagesArray:Array.isArray(E.messages)}),E}return l.data}catch(o){throw f.error("Failed to activate agent:",o),o}}async deleteAgent(e,t,s){try{f.info("[AgentIpcProxy] deleteAgent called",{agentId:e,workspaceId:t==null?void 0:t.id,softDelete:s==null?void 0:s.softDelete}),f.info("[AgentIpcProxy] Invoking DELETE_SESSION IPC",{agentId:e,workspaceId:t==null?void 0:t.id});const r=await T(q.DELETE_SESSION,{agentId:e,sessionId:e,workspaceId:t==null?void 0:t.id});return f.info("[AgentIpcProxy] DELETE_SESSION response",{response:r}),r.data}catch(r){throw f.error("[AgentIpcProxy] Failed to delete agent:",r),r}}}const As=new dt;class ut{constructor(){g(this,"loadSessionCache",new Map);g(this,"LOAD_SESSION_CACHE_TTL_MS",5e3);g(this,"saveDebounceTimers",new Map);g(this,"pendingSaves",new Map);g(this,"SAVE_DEBOUNCE_MS",500)}async save(e,t){try{await T(j.SAVE,{key:e,data:t})}catch(s){f.error("Failed to save:",s),localStorage.setItem(e,JSON.stringify(t))}}async saveSession(e,t,s){if(!e||!e.id||!Array.isArray(e.messages)||!e.status){f.warn("Cannot save session: missing required fields",{hasSession:!!e,hasId:!!(e!=null&&e.id),sessionId:e==null?void 0:e.id,hasMessages:Array.isArray(e==null?void 0:e.messages),hasStatus:!!(e!=null&&e.status),status:e==null?void 0:e.status,sessionKeys:e?Object.keys(e).join(","):"N/A"});return}if(!t){f.warn("Cannot save session: workspaceId is undefined",{agentId:e==null?void 0:e.id,sessionHasWorkspaceId:!!(e!=null&&e.workspaceId)});return}const r=e.id;if(s!=null&&s.immediate){const o=this.saveDebounceTimers.get(r);return o&&(clearTimeout(o),this.saveDebounceTimers.delete(r),this.pendingSaves.delete(r)),this.doSaveSession(e,t)}this.pendingSaves.set(r,{session:e,workspaceId:t});const i=this.saveDebounceTimers.get(r);i&&clearTimeout(i);const n=setTimeout(()=>{const o=this.pendingSaves.get(r);o&&(this.pendingSaves.delete(r),this.saveDebounceTimers.delete(r),this.doSaveSession(o.session,o.workspaceId).catch(u=>{f.error("Failed to save debounced session:",u)}))},this.SAVE_DEBOUNCE_MS);this.saveDebounceTimers.set(r,n)}async doSaveSession(e,t){try{const s=JSON.parse(JSON.stringify(e));await T(j.SAVE_SESSION,{session:s,workspaceId:t,options:{immediate:!0}})}catch(s){f.error("Failed to save session:",s)}}async load(e){try{return(await T(j.LOAD,{key:e})).data}catch{const s=localStorage.getItem(e);return s?JSON.parse(s):null}}async loadAgentConfig(e,t){var s;try{if(!e)return f.warn("loadAgentConfig called with empty agentId"),null;typeof e=="object"&&f.warn("loadAgentConfig received object instead of string:",{type:typeof e,constructor:(s=e==null?void 0:e.constructor)==null?void 0:s.name,value:e});const r=e?String(e):"";let i=t;if(!i){const o=h.currentWorkspace,u=o==null?void 0:o.agents.get(r);i=(u==null?void 0:u.session.workspaceId)||""}return(await T(j.LOAD_AGENT_CONFIG,{agentId:r,workspaceId:i})).data}catch(r){return f.error("Failed to load agent config:",r),null}}async loadSession(e,t){if(!e)return f.warn("loadSession called with empty agentId"),null;if(!t)return f.warn("loadSession called without workspaceId",{agentId:e}),null;const s=e?String(e):"",r=String(t),i=`${r||"unknown"}/${s}`,n=this.loadSessionCache.get(i);if(n!=null&&n.promise)return f.debug("Waiting for in-flight loadSession request",{agentId:s,workspaceId:r}),n.promise;const o=Date.now();if(n&&o-n.timestamp<this.LOAD_SESSION_CACHE_TTL_MS)return f.debug("Returning cached loadSession data",{agentId:s,workspaceId:r,cacheAge:o-n.timestamp}),n.data;const u=(async()=>{try{const l=await T(j.LOAD_SESSION,{agentId:s,workspaceId:r});return f.debug("loadSession response from IPC",{agentId:s,workspaceId:r,success:l==null?void 0:l.success,hasData:!!(l!=null&&l.data)}),(l==null?void 0:l.data)||null}catch(l){return f.error("Failed to load session:",l),null}})();this.loadSessionCache.set(i,{data:(n==null?void 0:n.data)||null,timestamp:o,promise:u});const c=await u;return this.loadSessionCache.set(i,{data:c,timestamp:Date.now(),promise:void 0}),c}async loadMessages(e,t){try{const s=await this.loadSession(e,t);return s&&s.messages?(f.info("Loaded messages from session",{agentId:e,workspaceId:t,messageCount:s.messages.length}),s.messages):(f.debug("No session found for messages",{agentId:e,workspaceId:t}),[])}catch(s){return f.error("Failed to load messages:",s),null}}async delete(e){try{await T(j.DELETE,{key:e})}catch(t){f.warn("Failed to delete via IPC, falling back to localStorage:",t),localStorage.removeItem(e)}}}const ws=new ut;class gt{async start(e){try{await T(q.LIFECYCLE_START,{agentId:e})}catch(t){f.error("Failed to start agent:",t)}}async stop(e){try{await T(q.LIFECYCLE_STOP,{agentId:e})}catch(t){f.error("Failed to stop agent:",t)}}}const ks=new gt;class ht{async sendMessage(e,t){try{await T(q.MESSAGING_SEND,{agentId:e,message:t})}catch(s){f.error("Failed to send message:",s)}}async receiveMessage(e){try{return(await T(q.MESSAGING_RECEIVE,{agentId:e})).data}catch(t){return f.error("Failed to receive message:",t),null}}}const Rs=new ht;class _s{constructor(){g(this,"streamManager",pe.getInstance())}async startStream(e,t,s){this.streamManager.startStream({agentId:e,sessionId:t,workspaceId:""},s?{onChunk:s.onChunk,onComplete:s.onComplete,onError:s.onError}:void 0)}async stopStream(e){this.streamManager.cancelStream(e)}getStats(){return this.streamManager.getMetrics()}}const bs=new _s;class Ms{constructor(){g(this,"streamingAgents",new Set);g(this,"recoveryData",new Map)}async needsRecovery(e,t){return this.recoveryData.has(e)}async recoverSession(e,t){return this.recoveryData.delete(e.id),e}async markStreaming(e){this.streamingAgents.add(e)}async markComplete(e){this.streamingAgents.delete(e),this.recoveryData.delete(e)}async getStats(){return{streamingAgents:this.streamingAgents.size,recoveryPending:this.recoveryData.size}}}const Cs=new Ms,tr=Object.freeze(Object.defineProperty({__proto__:null,AgentIpcProxy:dt,AgentLifecycleService:gt,AgentMessagingService:ht,ConfigCacheProxyService:rt,ErrorBoundaryService:fe,PersistenceService:ut,agentIpcProxy:As,agentLifecycleService:ks,agentMessagingService:Rs,cancelPendingStoreUpdate:Ts,configCache:os,errorBoundary:is,notifyAgentSubscribers:ct,persistenceService:ws,recoveryService:Cs,sessionStore:lt,sessionStoreData:Pe,streamingService:bs,subscribeToAgent:Ss,unifiedStateStore:h},Symbol.toStringTag,{value:"Module"}));var Os=Ot("<div><!></div>");function Ns(a,e){if(new.target)return qt({component:Ns,...a});Rt(e,!0);let t=ke(e,"target",7,"body"),s=ke(e,"zIndex",7,10),r=ke(e,"children",7),i,n=W(!1);_t(()=>{let m;return typeof t()=="string"?m=document.querySelector(t()):m=t(),m||(m=document.body),i=document.createElement("div"),i.className="portal-container",i.style.zIndex=String(s()),i.style.position="relative",m.appendChild(i),G(n,!0),()=>{i&&i.parentNode&&i.parentNode.removeChild(i)}});function o(m){return i&&i.appendChild(m),{destroy(){m&&m.parentNode&&m.parentNode.removeChild(m)}}}var u={get target(){return t()},set target(m="body"){t(m),ve()},get zIndex(){return s()},set zIndex(m=10){s(m),ve()},get children(){return r()},set children(m){r(m),ve()},$set:Xt,$on:(m,w)=>jt(e,m,w)},c=bt(),l=Mt(c);{var E=m=>{var w=Os(),p=Nt(w);Dt(p,r),Lt(w),Ht(w,v=>o==null?void 0:o(v)),Ge(m,w)};Yt(l,m=>{U(n)&&m(E)})}return Ge(a,c),Ct(u)}const K=M("AuggieModelsClient");async function Ds(){if(typeof window>"u")return K.debug("Skipping auggie models fetch - not in browser environment"),[];try{K.debug("Getting models from auggie");const a=await T("auggie:get-models");return a.success?(a.warning&&K.warn(a.warning),a.data||[]):(K.error(`Failed to get models from auggie: ${a.error||"unknown error"}`),[])}catch(a){return K.error("Error getting models from auggie",{error:a}),[]}}const J=M("ClaudeCodeModelsClient");async function Ls(){if(typeof window>"u")return J.debug("Skipping Claude Code models fetch - not in browser environment"),[];try{J.debug("Getting models from Claude Code");const a=await T("claude-code:get-models");return a!=null&&a.success&&a.data?(J.info("Got models from Claude Code",{count:a.data.length}),a.data):(J.warn("Failed to get Claude Code models:",{error:a==null?void 0:a.error,warning:a==null?void 0:a.warning}),[])}catch(a){return J.warn("Failed to get Claude Code models:",{error:a}),[]}}const Z=M("CodexModelsClient");async function xs(){if(typeof window>"u")return Z.debug("Skipping Codex models fetch - not in browser environment"),[];try{Z.debug("Getting models from Codex");const a=await T("codex:get-models");return a!=null&&a.success&&a.data?(Z.info("Got models from Codex",{count:a.data.length}),a.data):(Z.warn("Failed to get Codex models:",{error:a==null?void 0:a.error,warning:a==null?void 0:a.warning}),[])}catch(a){return Z.warn("Failed to get Codex models:",{error:a}),[]}}const Q=M("CortexModelsClient");async function Ps(){if(typeof window>"u")return Q.debug("Skipping Cortex models fetch - not in browser environment"),[];try{Q.debug("Getting models from Cortex");const a=await T("cortex:get-models");return a!=null&&a.success&&a.data?(Q.info("Got models from Cortex",{count:a.data.length}),a.data):(Q.warn("Failed to get Cortex models:",{error:a==null?void 0:a.error,warning:a==null?void 0:a.warning}),[])}catch(a){return Q.warn("Failed to get Cortex models:",{error:a}),[]}}const ee=M("OpenCodeModelsClient");async function Fs(){if(typeof window>"u")return ee.debug("Skipping opencode models fetch - not in browser environment"),[];try{ee.debug("Getting models from opencode");const a=await T("opencode:get-models");return a!=null&&a.success&&a.data?(ee.info("Got models from opencode",{count:a.data.length}),a.data):(ee.warn("Failed to get OpenCode models:",{error:a==null?void 0:a.error,warning:a==null?void 0:a.warning}),[])}catch(a){return ee.warn("Failed to get OpenCode models:",{error:a}),[]}}const I=M("ModelStore"),Me="workspaces-selected-model",he="workspaces-workspace-models",tt="workspaces-provider-models";var re,ae,ie,ne,oe,ce;const x=class x{constructor(){F(this,re,W(Be(Se.UI_INITIAL_MODEL)));F(this,ae,W(Be([])));F(this,ie,W(!1));F(this,ne,W(!1));F(this,oe,W(null));F(this,ce,W(null));g(this,"retryAttempt",0);g(this,"retryTimeoutId",null);g(this,"workspaceModels",new Map);g(this,"providerModels",new Map);const e=localStorage.getItem(Me);e&&(this.selectedModel=e,I.debug("Loaded global model from localStorage:",e)),this.loadWorkspaceModels(),this.loadProviderModels(),this.loadModels()}get selectedModel(){return U(_(this,re))}set selectedModel(e){G(_(this,re),e,!0)}get availableModels(){return U(_(this,ae))}set availableModels(e){G(_(this,ae),e,!0)}get isLoadingModels(){return U(_(this,ie))}set isLoadingModels(e){G(_(this,ie),e,!0)}get modelsLoaded(){return U(_(this,ne))}set modelsLoaded(e){G(_(this,ne),e,!0)}get loadError(){return U(_(this,oe))}set loadError(e){G(_(this,oe),e,!0)}get loadedForProviderId(){return U(_(this,ce))}set loadedForProviderId(e){G(_(this,ce),e,!0)}loadWorkspaceModels(){try{const e=localStorage.getItem(he);if(e){const t=JSON.parse(e);this.workspaceModels=new Map(Object.entries(t)),I.debug("Loaded workspace models:",this.workspaceModels.size)}}catch(e){I.error("Failed to load workspace models:",e)}}saveWorkspaceModels(){try{const e=Object.fromEntries(this.workspaceModels);localStorage.setItem(he,JSON.stringify(e))}catch(e){I.error("Failed to save workspace models:",e)}}loadProviderModels(){try{const e=localStorage.getItem(tt);if(e){const t=JSON.parse(e);this.providerModels=new Map(Object.entries(t)),I.debug("Loaded provider models:",this.providerModels.size)}}catch(e){I.error("Failed to load provider models:",e)}}saveProviderModels(){try{const e=Object.fromEntries(this.providerModels);localStorage.setItem(tt,JSON.stringify(e))}catch(e){I.error("Failed to save provider models:",e)}}async loadModels(){if(this.modelsLoaded&&this.loadedForProviderId==="__all__"||this.isLoadingModels){I.debug("All provider models already loaded or loading, skipping");return}this.isLoadingModels=!0,this.loadError=null,I.debug("Loading models for ALL providers"),h.setModelsLoading(!0);try{const e=Object.keys(Et),t=Ue(),s=await Promise.allSettled(e.map(async n=>{const o=await this.fetchModelsForProvider(n);return{providerId:n,models:o}}));let r=[];for(const n of s)if(n.status==="fulfilled"&&n.value.models.length>0){const{providerId:o,models:c}=n.value,l=c.map(E=>o!==t?{...E,value:`${o}:${E.value}`}:E);r=r.concat(l)}if(r.length>0){this.availableModels=r,this.modelsLoaded=!0,this.loadedForProviderId="__all__",this.loadError=null,this.retryAttempt=0,I.info("Loaded models from all providers",{count:r.length}),h.setAvailableModels(this.availableModels);const n=r.map(o=>o.value),{providerId:c,modelId:l}=Ce(this.selectedModel);if(!(n.includes(this.selectedModel)||n.some(o=>o.endsWith(l)))&&this.availableModels.length>0){const o=yt(Se.UI_MODEL_PREFERENCE,n)??this.availableModels[0].value;I.warn("Selected model not in merged list, using preferred default",{selectedModel:this.selectedModel,fallbackModel:o}),this.selectModel(o)}}else this.loadError="No models available from any provider.",I.warn("No models from any provider"),this.scheduleAutoRetry(H.activeProviderId)}catch(e){const t=e instanceof Error?e.message:"Failed to load models";this.loadError=t,I.error("Failed to load models:",e),this.scheduleAutoRetry(H.activeProviderId)}finally{this.isLoadingModels=!1,h.setModelsLoading(!1)}}scheduleAutoRetry(e){if(this.retryAttempt>=x.MAX_AUTO_RETRIES){I.warn("Max auto-retries reached for model loading",{attempts:this.retryAttempt,providerId:e});return}const t=x.RETRY_DELAYS_MS[this.retryAttempt]??3e4;this.retryAttempt++,I.info(`Scheduling model load retry ${this.retryAttempt}/${x.MAX_AUTO_RETRIES} in ${t/1e3}s`),this.retryTimeoutId&&clearTimeout(this.retryTimeoutId),this.retryTimeoutId=setTimeout(()=>{this.retryTimeoutId=null,!this.modelsLoaded&&(I.info(`Auto-retrying model load (attempt ${this.retryAttempt}/${x.MAX_AUTO_RETRIES})`),this.loadModels())},t)}async fetchModelsForProvider(e){const t=We(e).id;switch(t){case"auggie":return Ds().catch(s=>(I.warn("Failed to load Auggie models:",s),[]));case"claude-code":return Ls().catch(s=>(I.warn("Failed to load Claude Code models:",s),[]));case"codex":return xs().catch(s=>(I.warn("Failed to load Codex models:",s),[]));case"cortex":return Ps().catch(s=>(I.warn("Failed to load Cortex models:",s),[]));case"opencode":return Fs().catch(s=>(I.warn("Failed to load OpenCode models:",s),[]));default:return I.warn("Unknown provider ID, cannot fetch models:",{providerId:e,normalizedId:t}),[]}}async reloadModelsForProvider(){I.info("Reloading models for all providers"),this.modelsLoaded=!1,this.loadedForProviderId=null,this.availableModels=[],this.loadError=null,await this.loadModels()}async retryLoadModels(){I.debug("Retrying model load..."),this.modelsLoaded=!1,this.loadError=null,this.retryAttempt=0,this.retryTimeoutId&&(clearTimeout(this.retryTimeoutId),this.retryTimeoutId=null),await this.loadModels()}async getModelsForProvider(e){const t=We(e).id;if(this.modelsLoaded&&this.loadedForProviderId===t)return this.availableModels;const s=await this.fetchModelsForProvider(t);if(s.length===0)return[];const r=Ue();return s.map(i=>t!==r?{...i,value:`${t}:${i.value}`}:i)}selectModel(e){I.debug("Selecting model:",{model:e,previousModel:this.selectedModel}),this.selectedModel=e,h.selectModel(e),localStorage.setItem(Me,e);const t=Ce(e).providerId;this.providerModels.set(t,e),this.saveProviderModels(),I.debug("Saved model for provider:",{providerId:t,model:e})}resetToDefaults(){I.info("Resetting model selections to defaults"),this.selectModel(Se.UI_INITIAL_MODEL),this.workspaceModels=new Map;try{localStorage.removeItem(he)}catch(e){I.warn("Failed to clear workspace model storage",e)}}resetToAuggieDefaults(){this.resetToDefaults()}setWorkspaceDefaultModel(e,t){I.debug("Setting workspace default model:",{workspaceId:e,model:t}),this.workspaceModels.set(e,t),this.saveWorkspaceModels()}getWorkspaceDefaultModel(e){const t=this.workspaceModels.get(e);return t?(I.debug("Using workspace default model:",{workspaceId:e,model:t}),t):(I.debug("No workspace default model, using global:",{workspaceId:e,model:this.selectedModel}),this.selectedModel)}hasWorkspaceDefaultModel(e){return this.workspaceModels.has(e)}clearWorkspaceDefaultModel(e){I.debug("Clearing workspace default model:",{workspaceId:e}),this.workspaceModels.delete(e),this.saveWorkspaceModels()}getGroupedModels(){if(this.availableModels.length===0)return[];const e=new Map;for(const s of this.availableModels){const r=Ce(s.value).providerId;e.has(r)||e.set(r,[]);e.get(r).push(s)}const t=[];for(const[s,r]of e){const i=Et[s];t.push({providerId:i?i.id:s,providerDisplayName:i?i.displayName:s,models:r})}return t}getModelLabel(e){if(!e)return e;const{modelId:t}=Ce(e),s=this.availableModels.find(r=>r.value===e||r.value===t);return(s==null?void 0:s.label)||e}getCurrentModelLabel(){return this.getModelLabel(this.selectedModel)}};re=new WeakMap,ae=new WeakMap,ie=new WeakMap,ne=new WeakMap,oe=new WeakMap,ce=new WeakMap,g(x,"MAX_AUTO_RETRIES",3),g(x,"RETRY_DELAYS_MS",[5e3,15e3,3e4]);let Le=x;const sr=new Le;function rr(a){return a}function ar(a){const e=a-1;return e*e*e+1}function ir(a){return--a*a*a*a*a+1}export{ps as A,Js as D,ls as E,Ns as P,Ht as a,Is as b,ar as c,as as d,ns as e,is as f,Qs as g,As as h,er as i,qe as j,os as k,Ss as l,sr as m,at as n,rr as o,ws as p,ir as q,it as r,lt as s,_e as t,fs as u,be as v,ct as w,Pe as x,Zs as y,tr as z};
